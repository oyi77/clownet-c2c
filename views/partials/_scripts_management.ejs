<script>
// --- MANAGEMENT FUNCTIONS ---

// Utility to escape HTML special characters
function escapeHtml(value) {
  if (value == null) return '';
  const str = String(value);
  return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;');
}

// Load management data when tab is shown
document.addEventListener('tab-shown', (e) => {
  if (e.detail.tabId === 'management') {
    loadManagementData();
  }
});

function loadManagementData() {
  // Load orchestrations
  socket.emit('list_orchestrations', {}, (response) => {
    if (response && response.orchestrations) {
      renderOrchestrations(response.orchestrations);
      document.getElementById('management-orchestrations-count').textContent = response.orchestrations.length;
    }
  });
  
  // Load shared resources counts
  socket.emit('list_shared_memory', {}, (response) => {
    if (response && response.keys) {
      document.getElementById('shared-memory-count').textContent = response.keys.length;
    }
  });
  
  socket.emit('list_files', {}, (response) => {
    if (response && response.files) {
      document.getElementById('shared-files-count').textContent = response.files.length;
    }
  });
  
  socket.emit('list_credentials', {}, (response) => {
    if (response && response.credentials) {
      document.getElementById('shared-credentials-count').textContent = response.credentials.length;
    }
  });
  
  // Load agent configurations
  socket.emit('list_agent_configs', {}, (response) => {
    if (response && response.configs) {
      renderAgentConfigs(response.configs);
      document.getElementById('agent-configs-count').textContent = response.configs.length;
      document.getElementById('management-configs-count').textContent = response.configs.length;
    }
  });
  
  // Update agent count
  if (agentsCache) {
    document.getElementById('management-agents-count').textContent = agentsCache.length;
  }
}

function renderOrchestrations(orchestrations) {
  const tbody = document.getElementById('orchestrations-table-body');
  
  if (!orchestrations || orchestrations.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-zinc-600 text-xs">No orchestrations found</td></tr>';
    return;
  }
  
  tbody.innerHTML = orchestrations.map(orch => {
    const statusClass = orch.status === 'running' ? 'text-green-500' : 
                       orch.status === 'completed' ? 'text-blue-500' : 
                       orch.status === 'cancelled' ? 'text-red-500' : 'text-zinc-500';
    
    return `
      <tr class="hover:bg-zinc-800/30 transition-colors">
        <td class="p-3 font-mono text-zinc-300">${escapeHtml(orch.name)}</td>
        <td class="p-3"><span class="text-[9px] font-bold ${statusClass}">${escapeHtml(String(orch.status || '').toUpperCase())}</span></td>
        <td class="p-3 text-zinc-400">${orch.agents.length}</td>
        <td class="p-3 text-zinc-400">${escapeHtml(orch.owner)}</td>
        <td class="p-3 text-zinc-600 text-[10px] font-mono">${new Date(orch.timestamp).toLocaleDateString()}</td>
        <td class="p-3">
          <div class="flex gap-1">
            <button onclick="viewOrchestration(${JSON.stringify(orch.orchId)})" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[9px] px-2 py-1 rounded">View</button>
            ${orch.status === 'created' ? 
              `<button onclick="startOrchestration(${JSON.stringify(orch.orchId)})" class="bg-green-600 hover:bg-green-500 text-black text-[9px] px-2 py-1 rounded">Start</button>` : 
              ''
            }
            ${orch.status === 'running' ? 
              `<button onclick="cancelOrchestration(${JSON.stringify(orch.orchId)})" class="bg-red-600 hover:bg-red-500 text-black text-[9px] px-2 py-1 rounded">Cancel</button>` : 
              ''
            }
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function renderAgentConfigs(configs) {
  const tbody = document.getElementById('configs-table-body');
  
  if (!configs || configs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-zinc-600 text-xs">No configurations found</td></tr>';
    return;
  }
  
  tbody.innerHTML = configs.map(config => `
    <tr class="hover:bg-zinc-800/30 transition-colors">
      <td class="p-3 font-mono text-zinc-300">${escapeHtml(config.name)}</td>
      <td class="p-3 text-zinc-400">v${escapeHtml(String(config.version || ''))}</td>
      <td class="p-3 text-zinc-400">${escapeHtml(config.owner)}</td>
      <td class="p-3 text-zinc-600 text-[10px] font-mono">${new Date(config.timestamp).toLocaleDateString()}</td>
      <td class="p-3">
        <div class="flex gap-1">
          <button onclick="viewAgentConfig(${JSON.stringify(config.configId)})" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[9px] px-2 py-1 rounded">View</button>
          <button onclick="cloneAgentConfig(${JSON.stringify(config.configId)})" class="bg-blue-600 hover:bg-blue-500 text-black text-[9px] px-2 py-1 rounded">Clone</button>
          <button onclick="deleteAgentConfig(${JSON.stringify(config.configId)})" class="bg-red-600 hover:bg-red-500 text-black text-[9px] px-2 py-1 rounded">Delete</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function viewOrchestration(orchId) {
  socket.emit('get_orchestration', { orchId: orchId }, (response) => {
    if (response && !response.error) {
      showOrchestrationModal(response);
    } else {
      showToast('Failed to load orchestration details', 'error');
    }
  });
}

function viewAgentConfig(configId) {
  socket.emit('get_agent_config', { configId: configId }, (response) => {
    if (response && !response.error) {
      showAgentConfigModal(response);
    } else {
      showToast('Failed to load configuration details', 'error');
    }
  });
}

function cloneAgentConfig(configId) {
  const newName = prompt('Enter name for cloned configuration:');
  if (newName) {
    socket.emit('clone_agent_config', { configId: configId, newName: newName }, (response) => {
      if (response && !response.error) {
        showToast('Configuration cloned successfully', 'success');
        loadManagementData(); // Refresh the list
      } else {
        showToast('Failed to clone configuration: ' + (response?.error || 'Unknown error'), 'error');
      }
    });
  }
}

function deleteAgentConfig(configId) {
  if (confirm('Are you sure you want to delete this configuration?')) {
    socket.emit('delete_agent_config', { configId: configId });
    showToast('Configuration deleted', 'warning');
    setTimeout(() => loadManagementData(), 1000);
  }
}

function startOrchestration(orchId) {
  socket.emit('start_orchestration', { orchId: orchId });
  showToast('Orchestration started', 'success');
  setTimeout(() => loadManagementData(), 1000);
}

function cancelOrchestration(orchId) {
  if (confirm('Are you sure you want to cancel this orchestration?')) {
    socket.emit('cancel_orchestration', { orchId: orchId });
    showToast('Orchestration cancelled', 'warning');
    setTimeout(() => loadManagementData(), 1000);
  }
}

function showOrchestrationModal(orchestration) {
  // Create modal dynamically
  const modalId = 'orchestration-detail-modal';
  let modal = document.getElementById(modalId);
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100]';
    document.body.appendChild(modal);
  }
  
  const statusClass = orchestration.status === 'running' ? 'text-green-500' : 
                     orchestration.status === 'completed' ? 'text-blue-500' : 
                     orchestration.status === 'cancelled' ? 'text-red-500' : 'text-zinc-500';
  
  modal.innerHTML = `
    <div class="bg-zinc-950 border border-zinc-800 rounded w-full max-w-4xl p-6 max-h-[90vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between mb-4 border-b border-zinc-800 pb-3">
        <div>
          <h2 class="text-zinc-100 font-bold text-lg">${orchestration.name}</h2>
          <div class="flex gap-3 mt-1">
            <span class="text-[10px] font-bold ${statusClass}">${orchestration.status.toUpperCase()}</span>
            <span class="text-[10px] text-zinc-500">Owner: ${orchestration.owner}</span>
          </div>
        </div>
        <button onclick="document.getElementById('${modalId}').classList.add('hidden');" class="text-zinc-500 text-xs">CLOSE</button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-zinc-900/50 p-4 rounded border border-zinc-800">
          <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-3">DETAILS</h3>
          <div class="space-y-2 text-[11px]">
            <div class="flex justify-between">
              <span class="text-zinc-400">Created</span>
              <span class="text-zinc-300">${new Date(orchestration.timestamp).toLocaleString()}</span>
            </div>
            ${orchestration.startedAt ? `
            <div class="flex justify-between">
              <span class="text-zinc-400">Started</span>
              <span class="text-zinc-300">${new Date(orchestration.startedAt).toLocaleString()}</span>
            </div>` : ''}
            ${orchestration.completedAt ? `
            <div class="flex justify-between">
              <span class="text-zinc-400">Completed</span>
              <span class="text-zinc-300">${new Date(orchestration.completedAt).toLocaleString()}</span>
            </div>` : ''}
            <div class="flex justify-between">
              <span class="text-zinc-400">Agents</span>
              <span class="text-zinc-300">${orchestration.agents.join(', ')}</span>
            </div>
          </div>
        </div>
        
        <div class="bg-zinc-900/50 p-4 rounded border border-zinc-800">
          <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-3">TASKS (${orchestration.tasks.length})</h3>
          <div class="max-h-32 overflow-y-auto text-[11px]">
            ${orchestration.tasks.map((task, index) => `
              <div class="py-1 border-b border-zinc-800/50 last:border-0">
                <div class="font-mono text-zinc-300">${index + 1}. ${task.description || task.command || 'Unnamed Task'}</div>
                ${task.target ? `<div class="text-zinc-600 text-[10px]">Target: ${task.target}</div>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      ${Object.keys(orchestration.results).length > 0 ? `
      <div class="flex-1 overflow-hidden flex flex-col">
        <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">RESULTS</h3>
        <div class="bg-black/40 border border-zinc-800 rounded flex-1 overflow-y-auto p-3 text-[10px] font-mono text-zinc-300">
          ${Object.entries(orchestration.results).map(([taskIndex, results]) => `
            <div class="mb-3">
              <div class="text-zinc-500 mb-1">Task ${parseInt(taskIndex) + 1}:</div>
              ${results.map(result => `
                <div class="ml-2 mb-1">
                  <span class="text-zinc-600">[${result.agentId}]</span>
                  <span class="text-zinc-300">${JSON.stringify(result.result, null, 2)}</span>
                </div>
              `).join('')}
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}
    </div>
  `;
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function showAgentConfigModal(config) {
  const modalId = 'agent-config-detail-modal';
  let modal = document.getElementById(modalId);
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100]';
    document.body.appendChild(modal);
  }
  
  // Format the config data for display
  const formattedData = JSON.stringify(config.data, null, 2);
  
  // Create version history
  const versionHistory = config.history.map(version => `
    <div class="py-2 border-b border-zinc-800/50 last:border-0">
      <div class="flex justify-between items-center">
        <div class="font-mono text-zinc-300 text-[11px]">Version ${version.version}</div>
        <div class="text-zinc-500 text-[10px]">${new Date(version.timestamp).toLocaleString()}</div>
      </div>
      <div class="text-zinc-600 text-[10px] mt-1">Author: ${version.author}${version.revertedFrom ? ` (Reverted from v${version.revertedFrom})` : ''}</div>
      <button onclick="revertToConfigVersion('${config.configId}', ${version.version})" class="mt-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[9px] px-2 py-1 rounded">Revert to this version</button>
    </div>
  `).join('');
  
  modal.innerHTML = `
    <div class="bg-zinc-950 border border-zinc-800 rounded w-full max-w-4xl p-6 max-h-[90vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between mb-4 border-b border-zinc-800 pb-3">
        <div>
          <h2 class="text-zinc-100 font-bold text-lg">${config.name}</h2>
          <div class="flex gap-3 mt-1">
            <span class="text-[10px] font-bold text-blue-500">VERSION ${config.version}</span>
            <span class="text-[10px] text-zinc-500">Owner: ${config.owner}</span>
          </div>
        </div>
        <button onclick="document.getElementById('${modalId}').classList.add('hidden');" class="text-zinc-500 text-xs">CLOSE</button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-zinc-900/50 p-4 rounded border border-zinc-800">
          <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-3">CONFIGURATION DATA</h3>
          <div class="max-h-48 overflow-y-auto bg-black/40 border border-zinc-800 rounded p-3 text-[10px] font-mono text-zinc-300">
            <pre>${formattedData}</pre>
          </div>
        </div>
        
        <div class="bg-zinc-900/50 p-4 rounded border border-zinc-800">
          <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-3">DETAILS</h3>
          <div class="space-y-2 text-[11px]">
            <div class="flex justify-between">
              <span class="text-zinc-400">Created</span>
              <span class="text-zinc-300">${new Date(config.timestamp).toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-zinc-400">Config ID</span>
              <span class="text-zinc-300 font-mono text-[9px]">${config.configId}</span>
            </div>
            ${config.clonedFrom ? `
            <div class="flex justify-between">
              <span class="text-zinc-400">Cloned From</span>
              <span class="text-zinc-300 font-mono text-[9px]">${config.clonedFrom}</span>
            </div>` : ''}
          </div>
        </div>
      </div>
      
      <div class="flex-1 overflow-hidden flex flex-col">
        <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">VERSION HISTORY</h3>
        <div class="bg-black/40 border border-zinc-800 rounded flex-1 overflow-y-auto p-3 text-[10px]">
          ${versionHistory || '<div class="text-zinc-600 text-center py-4">No version history</div>'}
        </div>
      </div>
      
      <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-zinc-800">
        <button onclick="cloneAgentConfig('${config.configId}')" class="bg-blue-600 hover:bg-blue-500 text-black text-[10px] font-bold px-3 py-1.5 rounded uppercase tracking-wider transition-all">
          CLONE
        </button>
        <button onclick="deleteAgentConfig('${config.configId}')" class="bg-red-600 hover:bg-red-500 text-black text-[10px] font-bold px-3 py-1.5 rounded uppercase tracking-wider transition-all">
          DELETE
        </button>
      </div>
    </div>
  `;
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function revertToConfigVersion(configId, version) {
  if (confirm(`Are you sure you want to revert to version ${version}?`)) {
    socket.emit('revert_agent_config', { configId: configId, version: version }, (response) => {
      if (response && !response.error) {
        showToast('Configuration reverted successfully', 'success');
        // Close the modal and refresh
        document.getElementById('agent-config-detail-modal')?.classList.add('hidden');
        loadManagementData();
      } else {
        showToast('Failed to revert configuration: ' + (response?.error || 'Unknown error'), 'error');
      }
    });
  }
}

// Shared Memory Modal
function showSharedMemoryModal() {
  socket.emit('list_shared_memory', {}, (response) => {
    if (response && response.keys) {
      renderSharedResourceModal('Shared Memory', response.keys, 'memory');
    }
  });
}

// Shared Files Modal
function showSharedFilesModal() {
  socket.emit('list_files', {}, (response) => {
    if (response && response.files) {
      renderSharedResourceModal('Shared Files', response.files, 'files');
    }
  });
}

// Shared Credentials Modal
function showSharedCredentialsModal() {
  socket.emit('list_credentials', {}, (response) => {
    if (response && response.credentials) {
      renderSharedResourceModal('Shared Credentials', response.credentials, 'credentials');
    }
  });
}

function renderSharedResourceModal(title, items, type) {
  const modalId = `${type}-modal`;
  let modal = document.getElementById(modalId);
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100]';
    document.body.appendChild(modal);
  }
  
  const content = items.map(item => {
    switch (type) {
      case 'memory':
        return `
          <div class="flex justify-between items-center p-2 border-b border-zinc-800/50">
            <div>
              <div class="font-mono text-zinc-300 text-[11px]">${item.key}</div>
              <div class="text-zinc-600 text-[10px]">Owner: ${item.owner}</div>
            </div>
            <div class="text-zinc-500 text-[10px]">${new Date(item.timestamp).toLocaleDateString()}</div>
          </div>
        `;
      case 'files':
        return `
          <div class="flex justify-between items-center p-2 border-b border-zinc-800/50">
            <div>
              <div class="font-mono text-zinc-300 text-[11px]">${item.filename}</div>
              <div class="text-zinc-600 text-[10px]">${(item.size / 1024).toFixed(1)} KB • Owner: ${item.owner}</div>
            </div>
            <div class="text-zinc-500 text-[10px]">${new Date(item.timestamp).toLocaleDateString()}</div>
          </div>
        `;
      case 'credentials':
        return `
          <div class="flex justify-between items-center p-2 border-b border-zinc-800/50">
            <div>
              <div class="font-mono text-zinc-300 text-[11px]">${item.service}</div>
              <div class="text-zinc-600 text-[10px]">Owner: ${item.owner} • Shared with: ${item.sharedWith.length} agents</div>
            </div>
            <div class="text-zinc-500 text-[10px]">${new Date(item.timestamp).toLocaleDateString()}</div>
          </div>
        `;
    }
  }).join('');
  
  modal.innerHTML = `
    <div class="bg-zinc-950 border border-zinc-800 rounded w-full max-w-2xl p-5 max-h-[80vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between mb-4 border-b border-zinc-800 pb-3">
        <div class="text-zinc-100 font-bold">${title}</div>
        <button onclick="document.getElementById('${modalId}').classList.add('hidden');" class="text-zinc-500 text-xs">CLOSE</button>
      </div>
      <div class="flex-1 overflow-y-auto">
        ${content || '<div class="text-zinc-600 text-center py-8 text-sm">No items found</div>'}
      </div>
    </div>
  `;
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

// Agent Configs Modal
function showAgentConfigsModal() {
  socket.emit('list_agent_configs', {}, (response) => {
    if (response && response.configs) {
      renderSharedResourceModal('Agent Configurations', response.configs, 'configs');
    }
  });
}

function renderSharedResourceModal(title, items, type) {
  const modalId = `${type}-modal`;
  let modal = document.getElementById(modalId);
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100]';
    document.body.appendChild(modal);
  }
  
  const content = items.map(item => {
    switch (type) {
      case 'memory':
        return `
          <div class="flex justify-between items-center p-2 border-b border-zinc-800/50">
            <div>
              <div class="font-mono text-zinc-300 text-[11px]">${item.key}</div>
              <div class="text-zinc-600 text-[10px]">Owner: ${item.owner}</div>
            </div>
            <div class="text-zinc-500 text-[10px]">${new Date(item.timestamp).toLocaleDateString()}</div>
          </div>
        `;
      case 'files':
        return `
          <div class="flex justify-between items-center p-2 border-b border-zinc-800/50">
            <div>
              <div class="font-mono text-zinc-300 text-[11px]">${item.filename}</div>
              <div class="text-zinc-600 text-[10px]">${(item.size / 1024).toFixed(1)} KB • Owner: ${item.owner}</div>
            </div>
            <div class="text-zinc-500 text-[10px]">${new Date(item.timestamp).toLocaleDateString()}</div>
          </div>
        `;
      case 'credentials':
        return `
          <div class="flex justify-between items-center p-2 border-b border-zinc-800/50">
            <div>
              <div class="font-mono text-zinc-300 text-[11px]">${item.service}</div>
              <div class="text-zinc-600 text-[10px]">Owner: ${item.owner} • Shared with: ${item.sharedWith.length} agents</div>
            </div>
            <div class="text-zinc-500 text-[10px]">${new Date(item.timestamp).toLocaleDateString()}</div>
          </div>
        `;
      case 'configs':
        return `
          <div class="flex justify-between items-center p-2 border-b border-zinc-800/50">
            <div>
              <div class="font-mono text-zinc-300 text-[11px]">${item.name}</div>
              <div class="text-zinc-600 text-[10px]">Owner: ${item.owner} • Version: ${item.version}</div>
            </div>
            <div class="text-zinc-500 text-[10px]">${new Date(item.timestamp).toLocaleDateString()}</div>
          </div>
        `;
    }
  }).join('');
  
  modal.innerHTML = `
    <div class="bg-zinc-950 border border-zinc-800 rounded w-full max-w-2xl p-5 max-h-[80vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between mb-4 border-b border-zinc-800 pb-3">
        <div class="text-zinc-100 font-bold">${title}</div>
        <button onclick="document.getElementById('${modalId}').classList.add('hidden');" class="text-zinc-500 text-xs">CLOSE</button>
      </div>
      <div class="flex-1 overflow-y-auto">
        ${content || '<div class="text-zinc-600 text-center py-8 text-sm">No items found</div>'}
      </div>
    </div>
  `;
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

// Button event listeners
document.getElementById('create-orchestration-btn')?.addEventListener('click', () => {
  showCreateOrchestrationModal();
});

document.getElementById('create-config-btn')?.addEventListener('click', () => {
  showCreateConfigModal();
});

document.getElementById('refresh-sessions-btn')?.addEventListener('click', () => {
  loadManagementData();
  showToast('Management data refreshed', 'success');
});

// Auto-refresh when orchestration events are received
socket.on('orchestration_created', () => loadManagementData());
socket.on('orchestration_started', () => loadManagementData());
socket.on('orchestration_completed', () => loadManagementData());
socket.on('orchestration_cancelled', () => loadManagementData());

// Orchestration Creation Modal
function showCreateOrchestrationModal() {
  // Get list of connected agents
  const agentsList = Object.keys(window.agents || {}).join(', ');
  
  const modalId = 'create-orchestration-modal';
  let modal = document.getElementById(modalId);
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100]';
    document.body.appendChild(modal);
  }
  
  modal.innerHTML = `
    <div class="bg-zinc-950 border border-zinc-800 rounded w-full max-w-3xl p-6 max-h-[90vh] overflow-auto">
      <div class="flex items-center justify-between mb-4 border-b border-zinc-800 pb-3">
        <div class="text-zinc-100 font-bold text-lg">Create New Orchestration</div>
        <button onclick="document.getElementById('${modalId}').classList.add('hidden');" class="text-zinc-500 text-xs">CLOSE</button>
      </div>
      
      <form id="create-orchestration-form" class="space-y-4">
        <div>
          <label class="block text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Orchestration Name</label>
          <input type="text" id="orch-name" required
            class="w-full bg-zinc-900 border border-zinc-700 rounded text-zinc-100 text-[11px] p-3 focus:border-zinc-500 focus:outline-none"
            placeholder="Enter orchestration name">
        </div>
        
        <div>
          <label class="block text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Agents (comma-separated)</label>
          <input type="text" id="orch-agents" required
            class="w-full bg-zinc-900 border border-zinc-700 rounded text-zinc-100 text-[11px] p-3 focus:border-zinc-500 focus:outline-none"
            placeholder="${agentsList || 'agent1, agent2'}">
          <div class="text-zinc-600 text-[9px] mt-1">Available agents: ${agentsList || 'No agents connected'}</div>
        </div>
        
        <div>
          <label class="block text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Execution Mode</label>
          <select id="orch-mode"
            class="w-full bg-zinc-900 border border-zinc-700 rounded text-zinc-100 text-[11px] p-3 focus:border-zinc-500 focus:outline-none">
            <option value="sequential">Sequential (one by one)</option>
            <option value="parallel">Parallel (all at once)</option>
          </select>
        </div>
        
        <div>
          <label class="block text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Tasks</label>
          <div id="orch-tasks-container" class="space-y-2 mb-2"></div>
          <button type="button" onclick="addOrchestrationTask()"
            class="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[10px] px-3 py-2 rounded uppercase tracking-wider">
            + Add Task
          </button>
        </div>
        
        <div class="flex justify-end gap-2 pt-4 border-t border-zinc-800">
          <button type="button" onclick="document.getElementById('${modalId}').classList.add('hidden');"
            class="bg-zinc-900 hover:bg-zinc-800 text-zinc-300 text-[10px] font-bold px-4 py-2 rounded uppercase tracking-wider transition-all">
            Cancel
          </button>
          <button type="submit"
            class="bg-blue-600 hover:bg-blue-500 text-black text-[10px] font-bold px-4 py-2 rounded uppercase tracking-wider transition-all">
            Create Orchestration
          </button>
        </div>
      </form>
    </div>
  `;
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  
  // Add first task by default
  addOrchestrationTask();
  
  // Setup form submission
  document.getElementById('create-orchestration-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const name = document.getElementById('orch-name').value.trim();
    const agentsInput = document.getElementById('orch-agents').value.trim();
    const mode = document.getElementById('orch-mode').value;
    
    if (!name || !agentsInput) {
      showToast('Please fill in all required fields', 'error');
      return;
    }
    
    const agents = agentsInput.split(',').map(a => a.trim()).filter(a => a);
    
    if (agents.length === 0) {
      showToast('Please specify at least one agent', 'error');
      return;
    }
    
    // Gather tasks from DOM
    const taskInputs = document.querySelectorAll('.orch-task-item');
    const tasks = [];
    
    taskInputs.forEach(taskDiv => {
      const description = taskDiv.querySelector('.task-description')?.value.trim();
      const command = taskDiv.querySelector('.task-command')?.value.trim();
      const target = taskDiv.querySelector('.task-target')?.value.trim();
      
      if (description || command) {
        tasks.push({
          description: description || '',
          command: command || '',
          target: target || '',
          mode: mode
        });
      }
    });
    
    if (tasks.length === 0) {
      showToast('Please add at least one task', 'error');
      return;
    }
    
    socket.emit('create_orchestration', {
      name: name,
      agents: agents,
      tasks: tasks
    }, (response) => {
      if (response && !response.error) {
        showToast('Orchestration created successfully', 'success');
        document.getElementById(modalId).classList.add('hidden');
        loadManagementData();
      } else {
        showToast('Failed to create orchestration: ' + (response?.error || 'Unknown error'), 'error');
      }
    });
  });
}

let taskCounter = 0;

function addOrchestrationTask() {
  const container = document.getElementById('orch-tasks-container');
  const taskId = ++taskCounter;
  
  const taskDiv = document.createElement('div');
  taskDiv.className = 'orch-task-item bg-zinc-900/50 p-3 rounded border border-zinc-800';
  taskDiv.innerHTML = `
    <div class="flex justify-between items-center mb-2">
      <span class="text-[10px] font-bold text-zinc-500 uppercase">Task ${taskId}</span>
      <button type="button" onclick="this.parentElement.parentElement.remove();"
        class="text-red-500 text-[9px] hover:text-red-400">Remove</button>
    </div>
    <div class="space-y-2">
      <input type="text" class="task-description w-full bg-zinc-800 border border-zinc-700 rounded text-zinc-100 text-[10px] p-2 focus:border-zinc-500 focus:outline-none"
        placeholder="Task description (e.g., 'Execute health check')">
      <input type="text" class="task-command w-full bg-zinc-800 border border-zinc-700 rounded text-zinc-100 font-mono text-[10px] p-2 focus:border-zinc-500 focus:outline-none"
        placeholder="Command (e.g., '/status')">
      <input type="text" class="task-target w-full bg-zinc-800 border border-zinc-700 rounded text-zinc-100 text-[10px] p-2 focus:border-zinc-500 focus:outline-none"
        placeholder="Target agent (optional, leave empty for all)">
    </div>
  `;
  
  container.appendChild(taskDiv);
}

// Configuration Creation Modal
function showCreateConfigModal() {
  const modalId = 'create-config-modal';
  let modal = document.getElementById(modalId);
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100]';
    document.body.appendChild(modal);
  }
  
  modal.innerHTML = `
    <div class="bg-zinc-950 border border-zinc-800 rounded w-full max-w-3xl p-6 max-h-[90vh] overflow-auto">
      <div class="flex items-center justify-between mb-4 border-b border-zinc-800 pb-3">
        <div class="text-zinc-100 font-bold text-lg">Create New Configuration</div>
        <button onclick="document.getElementById('${modalId}').classList.add('hidden');" class="text-zinc-500 text-xs">CLOSE</button>
      </div>
      
      <form id="create-config-form" class="space-y-4">
        <div>
          <label class="block text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Configuration Name</label>
          <input type="text" id="config-name" required
            class="w-full bg-zinc-900 border border-zinc-700 rounded text-zinc-100 text-[11px] p-3 focus:border-zinc-500 focus:outline-none"
            placeholder="Enter configuration name">
        </div>
        
        <div>
          <label class="block text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Configuration Data (JSON)</label>
          <textarea id="config-data" required rows="15"
            class="w-full bg-zinc-900 border border-zinc-700 rounded font-mono text-zinc-100 text-[10px] p-3 focus:border-zinc-500 focus:outline-none"
            placeholder='{
  "model": "gpt-4",
  "temperature": 0.7,
  "max_tokens": 2000,
  "skills": ["analysis", "coding"]
}'></textarea>
          <div id="config-validate-message" class="text-zinc-600 text-[9px] mt-1"></div>
        </div>
        
        <div class="flex justify-end gap-2 pt-4 border-t border-zinc-800">
          <button type="button" onclick="document.getElementById('${modalId}').classList.add('hidden');"
            class="bg-zinc-900 hover:bg-zinc-800 text-zinc-300 text-[10px] font-bold px-4 py-2 rounded uppercase tracking-wider transition-all">
            Cancel
          </button>
          <button type="submit"
            class="bg-blue-600 hover:bg-blue-500 text-black text-[10px] font-bold px-4 py-2 rounded uppercase tracking-wider transition-all">
            Save Configuration
          </button>
        </div>
      </form>
    </div>
  `;
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  
  const configDataInput = document.getElementById('config-data');
  const validateMessage = document.getElementById('config-validate-message');
  
  // Validate JSON in real-time
  configDataInput.addEventListener('input', () => {
    try {
      JSON.parse(configDataInput.value);
      validateMessage.textContent = '✓ Valid JSON';
      validateMessage.className = 'text-green-500 text-[9px] mt-1';
    } catch (e) {
      validateMessage.textContent = '✗ Invalid JSON: ' + e.message;
      validateMessage.className = 'text-red-500 text-[9px] mt-1';
    }
  });
  
  // Setup form submission
  document.getElementById('create-config-form').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const name = document.getElementById('config-name').value.trim();
    const dataInput = document.getElementById('config-data').value.trim();
    
    if (!name || !dataInput) {
      showToast('Please fill in all required fields', 'error');
      return;
    }
    
    try {
      const data = JSON.parse(dataInput);
      
      socket.emit('save_agent_config', {
        name: name,
        data: data
      }, (response) => {
        if (response && !response.error) {
          showToast('Configuration saved successfully', 'success');
          document.getElementById(modalId).classList.add('hidden');
          loadManagementData();
        } else {
          showToast('Failed to save configuration: ' + (response?.error || 'Unknown error'), 'error');
        }
      });
    } catch (e) {
      showToast('Invalid JSON configuration data', 'error');
    }
  });
}
</script>