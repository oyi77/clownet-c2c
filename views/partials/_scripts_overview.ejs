<script>
// --- OVERVIEW & METRICS FUNCTIONS ---

function loadOverviewMetrics() {
  Promise.all([
    fetch('/api/metrics').then(res => res.json()),
    fetch('/api/info').then(res => res.json())
  ]).then(([metrics, info]) => {
    document.getElementById('metric-tasks').textContent = (metrics.tasks_total || 0).toLocaleString();
    document.getElementById('metric-messages').textContent = (metrics.messages_total || 0).toLocaleString();
    document.getElementById('metric-agents').textContent = (metrics.agents_online || 0).toLocaleString();

    const successRate = metrics.tasks_total > 0
      ? ((metrics.tasks_success / metrics.tasks_total) * 100).toFixed(1)
      : 0;
    document.getElementById('metric-success').textContent = successRate + '%';

    renderSuccessChart(successRate, 100 - successRate);
    renderVolumeChart();

    const seconds = Math.floor(info.uptime || 0);
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    document.getElementById('metric-uptime').textContent = `${h}h ${m}m ${s}s`;

    if (info.server) {
      document.getElementById('metric-server-cpu').textContent = (info.server.cpu_percent || 0) + '%';
      document.getElementById('bar-server-cpu').style.width = (info.server.cpu_percent || 0) + '%';
      document.getElementById('metric-server-ram').textContent = (info.server.ram_percent || 0) + '%';
      document.getElementById('bar-server-ram').style.width = (info.server.ram_percent || 0) + '%';
      
      const serverSeconds = Math.floor(info.server.uptime || 0);
      const serverH = Math.floor(serverSeconds / 3600);
      const serverM = Math.floor((serverSeconds % 3600) / 60);
      document.getElementById('metric-server-uptime').textContent = `${serverH}h ${serverM}m`;
      document.getElementById('metric-server-host').textContent = info.server.hostname || '-';
    }
  }).catch(err => {
    console.error('Failed to load metrics:', err);
  });
}

function renderSuccessChart(success, fail) {
  const ctx = document.getElementById('chart-success-rate').getContext('2d');

  if (window.overviewSuccessChart) window.overviewSuccessChart.destroy();

  window.overviewSuccessChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Success', 'Failed'],
      datasets: [{
        data: [success, fail],
        backgroundColor: ['#22c55e', '#ef4444'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#a1a1aa', font: { size: 10 } }
        }
      }
    }
  });
}

let metricsRefreshInterval = null;

function startMetricsRefresh() {
  if (metricsRefreshInterval) return;
  loadOverviewMetrics();
  metricsRefreshInterval = setInterval(loadOverviewMetrics, 5000);
}

function stopMetricsRefresh() {
  if (metricsRefreshInterval) {
    clearInterval(metricsRefreshInterval);
    metricsRefreshInterval = null;
  }
}

function renderVolumeChart() {
  const ctx = document.getElementById('chart-volume').getContext('2d');

  if (window.overviewVolumeChart) window.overviewVolumeChart.destroy();

  const days = [];
  const data = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    days.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
    data.push(Math.floor(Math.random() * 50) + 10);
  }

  window.overviewVolumeChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: days,
      datasets: [{
        label: 'Tasks',
        data: data,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: '#27272a' },
          ticks: { color: '#a1a1aa' }
        },
        x: {
          grid: { display: false },
          ticks: { color: '#a1a1aa' }
        }
      },
      plugins: { legend: { display: false } }
    }
  });
}
</script>
