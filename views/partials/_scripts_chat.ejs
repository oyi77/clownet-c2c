<script>
  // --- CHAT & INTEL FUNCTIONS ---

  function handleChatUpdate(msg) {
    handleChatMessage(msg);
  }

  function handleTypingUpdate(msg) {
    if (!msg || !msg.from) return;
    if (msg.from === 'master-ui') return;
    const key = typingKey(msg);
    if (msg.isTyping) {
      if (activeTypers.has(key)) {
        clearTimeout(activeTypers.get(key).timeoutId);
      }
      const timeoutId = setTimeout(() => {
        activeTypers.delete(key);
        renderTypingIndicator();
      }, TYPING_TTL_MS);
      activeTypers.set(key, { from: msg.from, to: msg.to || 'all', timeoutId });
    } else {
      if (activeTypers.has(key)) {
        clearTimeout(activeTypers.get(key).timeoutId);
        activeTypers.delete(key);
      }
    }
    renderTypingIndicator();
  }

  function typingKey(msg) {
    return `${msg.from || ''}|${msg.to || 'all'}`;
  }

  function renderTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (!indicator) return;
    const relevant = Array.from(activeTypers.values()).filter(entry => {
      return entry.to === 'all' || entry.to === currentRoom || entry.from === currentRoom;
    });
    if (relevant.length === 0) {
      indicator.innerHTML = '';
      return;
    }
    const names = relevant.map(entry => entry.from).join(', ');
    indicator.innerHTML = '';
    const text = document.createElement('span');
    text.textContent = `${names} typing`;
    const dots = document.createElement('span');
    dots.className = 'typing-dots';
    for (let i = 0; i < 3; i += 1) {
      const dot = document.createElement('span');
      dots.appendChild(dot);
    }
    indicator.appendChild(text);
    indicator.appendChild(dots);
  }

  function appendIntel(entry) {
    if (entry.type === 'chat') {
      const msg = entry.message;
      handleChatMessage(msg);
    }
  }

  function formatTime(ts) {
    const date = ts ? new Date(ts) : new Date();
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function getMessageKey(msg) {
    return `${msg.ts || ''}|${msg.from || ''}|${msg.to || ''}|${msg.msg || ''}`;
  }

  function rememberMessage(key) {
    if (seenMessageKeys.has(key)) return false;
    seenMessageKeys.add(key);
    seenMessageQueue.push(key);
    if (seenMessageQueue.length > MAX_SEEN_MESSAGES) {
      const oldest = seenMessageQueue.shift();
      if (oldest) seenMessageKeys.delete(oldest);
    }
    return true;
  }

  function typeText(container, text, options = {}) {
    const safeText = text || '';
    const maxDuration = 900;
    const minSpeed = 8;
    const maxSpeed = 28;
    const speed = Math.min(maxSpeed, Math.max(minSpeed, Math.floor(maxDuration / Math.max(safeText.length, 1))));
    const caret = document.createElement('span');
    caret.className = 'typing-caret';
    container.textContent = '';
    container.appendChild(caret);

    let index = 0;
    const step = () => {
      if (index < safeText.length) {
        container.insertBefore(document.createTextNode(safeText[index]), caret);
        index += 1;
        if (options.onUpdate) options.onUpdate();
        setTimeout(step, options.speed || speed);
      } else {
        caret.remove();
        if (options.onDone) options.onDone();
      }
    };
    step();
  }

  const CHAT_STICKY_THRESHOLD_PX = 56;

  function isNearBottom(box, thresholdPx = CHAT_STICKY_THRESHOLD_PX) {
    if (!box) return true;
    const distance = box.scrollHeight - (box.scrollTop + box.clientHeight);
    return distance <= thresholdPx;
  }

  function addLog(sender, text, isMe, options = {}) {
    const box = document.getElementById('chat-box');
    if (!box) return;
    const stickToBottom = isNearBottom(box);

    const line = document.createElement('div');
    line.className = 'flex gap-4 message-in';

    const time = document.createElement('span');
    time.className = 'text-zinc-700 min-w-[60px] text-[10px] font-mono pt-1';
    time.textContent = `[${formatTime(options.timestamp)}]`;

    const name = document.createElement('span');
    name.className = `${isMe ? 'text-blue-500' : 'text-green-500'} font-bold uppercase min-w-[80px] text-right text-xs pt-0.5`;
    name.textContent = `${sender}:`;

    const message = document.createElement('div');
    message.className = 'text-zinc-300 flex-1 break-words text-xs leading-relaxed whitespace-pre-wrap';

    line.appendChild(time);
    line.appendChild(name);
    line.appendChild(message);
    box.appendChild(line);

    if (options.animate !== false && (text || '').length <= 800) {
      typeText(message, text, { onUpdate: () => { if (stickToBottom) box.scrollTop = box.scrollHeight; } });
    } else {
      message.textContent = text || '';
    }
    if (stickToBottom) requestAnimationFrame(() => { box.scrollTop = box.scrollHeight; });
  }

  function handleChatMessage(msg) {
    if (!msg || !msg.msg) return;
    const key = getMessageKey(msg);

    if (!rememberMessage(key)) return;

    if (typeof showToast === 'function') {
      const text = msg.msg || '';
      if (msg.from === 'server' && text.startsWith('ERROR:')) {
        showToast('Server error', 'error', 8000, { details: text, category: 'server' });
      } else if (text.startsWith('CLIENT_HANDLER_ERROR:')) {
        showToast('Client error', 'error', 8000, { details: `${msg.from}: ${text}`, category: 'server' });
      }
    }

    const room = msg.to === 'all' ? 'all' : (msg.to && msg.to.startsWith('#') ? msg.to : (msg.from === 'master-ui' ? msg.to : msg.from));
    if (!chatHistory[room]) chatHistory[room] = [];
    chatHistory[room].push(msg);

    const shouldDisplay = room === currentRoom || (currentRoom === 'all' && msg.to === 'all');
    if (shouldDisplay && msg.from !== 'master-ui') {
      addLog(msg.from, msg.msg, false, { timestamp: msg.ts });
    }
  }

  function handleRoomUpdate(data) {
    if (data.room === currentRoom) {
      updateMemberList(data.members);
    }
  }

  function updateMemberList(members) {
    const list = document.getElementById('member-list');
    if (!list) return;
    list.textContent = '';
    if (!members || members.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'text-[10px] text-zinc-700 italic text-center mt-4';
      empty.textContent = 'No members online';
      list.appendChild(empty);
      return;
    }

    members.forEach(m => {
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2 px-2 py-1 member-item';

      const statusDot = document.createElement('span');
      const statusColor = m && m.status === 'online' ? 'bg-green-500' : 'bg-zinc-600';
      statusDot.className = `w-1.5 h-1.5 rounded-full ${statusColor}`;

      const id = document.createElement('span');
      const idClass = m && m.id === 'master-ui' ? 'text-blue-400 font-bold' : 'text-zinc-400';
      id.className = `text-[11px] ${idClass}`;
      id.textContent = (m && m.id) ? m.id : '';

      const role = document.createElement('span');
      role.className = 'text-[8px] text-zinc-700 uppercase font-mono ml-auto';
      role.textContent = (m && m.role) ? m.role : '';

      row.appendChild(statusDot);
      row.appendChild(id);
      row.appendChild(role);
      list.appendChild(row);
    });
  }

  function selectRoom(target) {
    currentRoom = target;
    chatOffset = 0;
    document.querySelectorAll('.chat-room').forEach(r => r.classList.remove('active'));

    const btn = document.querySelector(`button[onclick*="selectRoom('${target}')"]`) ||
      document.querySelector(`button[onclick*="selectRoom(&quot;${target}&quot;)"]`);
    if (btn) btn.classList.add('active');

    const label = target.startsWith('#') ? target : (target === 'all' ? '# BROADCAST_ALL' : `@ ${target.toUpperCase()}`);
    document.getElementById('chat-title').innerText = label;
    document.getElementById('master-input').placeholder = `Message ${label}...`;

    const box = document.getElementById('chat-box');
    box.innerHTML = '';

    if (chatHistory[target] && chatHistory[target].length > 0) {
      renderChatBatch(target, true);
    } else {
      box.innerHTML = '<div class="text-zinc-700 italic mb-4 text-[10px] text-center mt-10">-- START OF ENCRYPTED CHANNEL --</div>';
    }

    socket.emit('join_room', { room: target });
    renderTypingIndicator();
  }

  function renderChatBatch(room, isInitial = false) {
    const box = document.getElementById('chat-box');
    const history = chatHistory[room] || [];
    const start = Math.max(0, history.length - (chatOffset + CHAT_BATCH_SIZE));
    const end = history.length - chatOffset;
    const batch = history.slice(start, end);

    if (batch.length === 0) return;

    const fragment = document.createDocumentFragment();
    batch.forEach(msg => {
      const el = createMessageElement(msg.from, msg.msg, msg.from === 'master-ui', { timestamp: msg.ts });
      fragment.appendChild(el);
    });

    const oldScrollHeight = box.scrollHeight;
    if (isInitial) {
      box.appendChild(fragment);
      box.scrollTop = box.scrollHeight;
    } else {
      box.prepend(fragment);
      box.scrollTop = box.scrollHeight - oldScrollHeight;
    }
    chatOffset += batch.length;
  }

  function createMessageElement(sender, text, isMe, options = {}) {
    const line = document.createElement('div');
    line.className = 'flex gap-4 message-in';
    const time = document.createElement('span');
    time.className = 'text-zinc-700 min-w-[60px] text-[10px] font-mono pt-1';
    time.textContent = `[${formatTime(options.timestamp)}]`;
    const name = document.createElement('span');
    name.className = `${isMe ? 'text-blue-500' : 'text-green-500'} font-bold uppercase min-w-[80px] text-right text-xs pt-0.5`;
    name.textContent = `${sender}:`;
    const message = document.createElement('div');
    message.className = 'text-zinc-300 flex-1 break-words text-xs leading-relaxed whitespace-pre-wrap';
    message.textContent = text || '';
    line.appendChild(time);
    line.appendChild(name);
    line.appendChild(message);
    return line;
  }

  document.getElementById('chat-box').addEventListener('scroll', (e) => {
    if (e.target.scrollTop <= 1 && chatOffset < (chatHistory[currentRoom] || []).length) {
      renderChatBatch(currentRoom);
    }
  });

  async function joinNewRoom() {
    const name = await showPrompt('JOIN ROOM', 'Enter room name (e.g. #squad-alpha):', '#');
    if (name) {
      const roomId = name.startsWith('#') ? name : '#' + name;
      selectRoom(roomId);
      const roomList = document.getElementById('room-list');
      const escapedRoomId = roomId.replace(/'/g, "\\'");
      if (!document.querySelector(`button[onclick*="selectRoom('${escapedRoomId}')"]`)) {
        const btn = document.createElement('button');
        btn.onclick = () => selectRoom(roomId);
        btn.className = "chat-room w-full text-left px-4 py-3 text-xs text-zinc-400 hover:bg-zinc-800 border-b border-zinc-800/50 uppercase";
        btn.innerText = roomId;
        roomList.appendChild(btn);
      }
    }
  }

  function handleTraffic(entry) {
    const feed = document.getElementById('traffic-feed');
    const lines = document.getElementById('traffic-lines');
    if (!feed || !lines) return;

    feed.classList.remove('hidden');
    const div = document.createElement('div');
    const colorClass = entry.status === 'blocked' ? 'text-red-500' : (entry.status === 'flagged' ? 'text-yellow-500' : 'text-zinc-500');
    div.className = `${colorClass} flex gap-2`;

    const time = document.createElement('span');
    time.textContent = `[${new Date().toLocaleTimeString()}]`;

    const agent = document.createElement('span');
    agent.className = 'font-bold';
    agent.textContent = entry && entry.agent_id ? entry.agent_id : '';

    const cmd = document.createElement('span');
    cmd.textContent = entry && entry.cmd ? entry.cmd : '';

    const status = document.createElement('span');
    status.className = 'italic';
    status.textContent = `(${entry && entry.status ? entry.status : ''})`;

    div.appendChild(time);
    div.appendChild(agent);
    div.appendChild(cmd);
    div.appendChild(status);

    lines.prepend(div);
    if (lines.children.length > 50) lines.lastChild.remove();
  }

  // Master Input Handler
  if (masterInput) {
    let typingActive = false;
    let typingTimeoutId = null;
    let lastTypingSent = 0;

    const sendTyping = (isTyping) => {
      socket.emit('typing', { to: currentRoom, isTyping: isTyping });
    };

    const stopTyping = () => {
      if (!typingActive) return;
      typingActive = false;
      if (typingTimeoutId) clearTimeout(typingTimeoutId);
      typingTimeoutId = null;
      sendTyping(false);
    };

    masterInput.addEventListener('input', () => {
      const hasText = masterInput.value.trim().length > 0;
      const now = Date.now();
      if (hasText) {
        if (!typingActive) {
          typingActive = true;
          sendTyping(true);
          lastTypingSent = now;
        } else if (now - lastTypingSent > TYPING_THROTTLE_MS) {
          sendTyping(true);
          lastTypingSent = now;
        }
        if (typingTimeoutId) clearTimeout(typingTimeoutId);
        typingTimeoutId = setTimeout(() => { stopTyping(); }, TYPING_TTL_MS);
      } else {
        stopTyping();
      }
    });

    masterInput.addEventListener('blur', () => { stopTyping(); });

    masterInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const msg = masterInput.value.trim();
        if (!msg) return;

        stopTyping();

        if (msg.startsWith('/exec ')) {
          const cmd = msg.replace('/exec ', '');
          socket.emit('dispatch', { to: currentRoom === 'all' ? 'all' : currentRoom, cmd: cmd });
          addLog('SYSTEM', `Dispatching command to ${currentRoom}: ${cmd}`, true, { animate: false });
        } else {
          const msgId = `local-${++localMessageCounter}`;
          socket.emit('chat', { to: currentRoom, msg: msg, localId: msgId });
          addLog('YOU', msg, true, { animate: false });

          if (!chatHistory[currentRoom]) chatHistory[currentRoom] = [];
          chatHistory[currentRoom].push({
            from: 'master-ui',
            to: currentRoom,
            msg: msg,
            ts: new Date().toISOString(),
            localId: msgId
          });
        }
        masterInput.value = '';
      }
    });
  }
</script>
