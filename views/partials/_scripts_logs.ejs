<script>
let logsAutoScrollEnabled = true;

function readLogScrollState(el) {
  if (!el) return { top: 0 };
  return { top: el.scrollTop };
}

function applyLogScrollState(el, state) {
  if (!el) return;
  if (logsAutoScrollEnabled) {
    el.scrollTop = el.scrollHeight;
    return;
  }
  const maxTop = Math.max(0, el.scrollHeight - el.clientHeight);
  const previousTop = state && Number.isFinite(state.top) ? state.top : 0;
  el.scrollTop = Math.min(Math.max(previousTop, 0), maxTop);
}

function refreshLogs() {
  const serverSearch = document.getElementById('server-logs-search')?.value || '';
  const taskSearch = document.getElementById('task-logs-search')?.value || '';
  const serverLogsEl = document.getElementById('server-logs');
  const taskLogsEl = document.getElementById('task-logs');
  const serverState = readLogScrollState(serverLogsEl);
  const taskState = readLogScrollState(taskLogsEl);

  fetch(`/api/logs/server?search=${encodeURIComponent(serverSearch)}`)
    .then(res => res.json())
    .then(data => {
      if (!serverLogsEl) return;
      serverLogsEl.innerText = (data.lines || []).join('\n');
      applyLogScrollState(serverLogsEl, serverState);
    })
    .catch(err => console.error('Failed to fetch server logs:', err));

  fetch(`/api/logs/tasks?search=${encodeURIComponent(taskSearch)}`)
    .then(res => res.json())
    .then(data => {
      if (!taskLogsEl) return;
      taskLogsEl.innerHTML = '';
      (data.tasks || []).forEach(t => {
        const rowEl = document.createElement('div');
        rowEl.className = 'mb-2 pb-2 border-b border-zinc-800/30 last:border-0';

        const headerEl = document.createElement('div');
        headerEl.className = 'flex justify-between text-zinc-500 mb-1';

        const idEl = document.createElement('span');
        idEl.className = 'font-bold text-zinc-400';
        idEl.textContent = `#${String(t.id || '').substring(0, 8)}`;

        const timeEl = document.createElement('span');
        timeEl.textContent = new Date(t.created_at || t.timestamp).toLocaleString();

        headerEl.appendChild(idEl);
        headerEl.appendChild(timeEl);

        const cmdEl = document.createElement('div');
        cmdEl.className = 'text-zinc-300 mb-1';
        cmdEl.textContent = `> ${String(t.cmd)}`;

        const resultEl = document.createElement('div');
        resultEl.className = 'text-[10px] text-zinc-600 font-mono truncate';
        const resultValue = typeof t.result === 'object' ? JSON.stringify(t.result) : t.result || 'Pending';
        resultEl.textContent = `Result: ${resultValue}`;

        rowEl.appendChild(headerEl);
        rowEl.appendChild(cmdEl);
        rowEl.appendChild(resultEl);
        taskLogsEl.appendChild(rowEl);
      });
      applyLogScrollState(taskLogsEl, taskState);
    })
    .catch(err => console.error('Failed to fetch task logs:', err));
}

function setupLogsSearch() {
  const serverSearch = document.getElementById('server-logs-search');
  const taskSearch = document.getElementById('task-logs-search');
  const autoToggle = document.getElementById('logs-autoscroll-toggle');
  let serverTimeout;
  let taskTimeout;

  logsAutoScrollEnabled = autoToggle ? autoToggle.checked : true;

  if (autoToggle) {
    autoToggle.addEventListener('change', (event) => {
      logsAutoScrollEnabled = Boolean(event.target.checked);
      if (logsAutoScrollEnabled) {
        applyLogScrollState(document.getElementById('server-logs'), { top: 0 });
        applyLogScrollState(document.getElementById('task-logs'), { top: 0 });
      }
    });
  }

  if (serverSearch) {
    serverSearch.addEventListener('input', () => {
      clearTimeout(serverTimeout);
      serverTimeout = setTimeout(refreshLogs, 300);
    });
  }

  if (taskSearch) {
    taskSearch.addEventListener('input', () => {
      clearTimeout(taskTimeout);
      taskTimeout = setTimeout(refreshLogs, 300);
    });
  }

  document.getElementById('logs-refresh')?.addEventListener('click', refreshLogs);
  document.getElementById('task-logs-refresh')?.addEventListener('click', refreshLogs);

  if (document.getElementById('logs') && !document.getElementById('logs').classList.contains('hidden')) {
    refreshLogs();
  }
}

setupLogsSearch();
</script>
