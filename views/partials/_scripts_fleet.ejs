<script>
// --- FLEET MANAGEMENT FUNCTIONS ---

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    const toast = document.createElement('div');
    toast.className = "fixed bottom-4 right-4 bg-green-600 text-black text-[10px] font-bold px-4 py-2 rounded shadow-lg z-[10000] animate-bounce";
    toast.innerText = "COPIED_TO_CLIPBOARD";
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  });
}

function handleFleetUpdate(agents) {
  agentsCache = agents;
  const grid = document.getElementById('fleet-grid');
  agents.forEach(a => { agentCache[a.id] = a; });
  updateTargetOptions(agents);

  if (agents.length === 0) {
    grid.innerHTML = '<div class="col-span-3 text-center py-20 text-zinc-600">NO AGENTS ONLINE</div>';
  } else {
    grid.innerHTML = agents.map(a => `
      <div class="bg-zinc-900 border border-zinc-800 p-5 rounded terminal-glow relative group flex flex-col justify-between" data-agent-id="${a.id}">
        <div>
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-zinc-100 font-bold text-lg mb-1">${a.id}</h3>
              <div class="text-[10px] text-zinc-500 tracking-widest font-mono">ROLE: <span class="text-zinc-300">${a.role.toUpperCase()}</span></div>
            </div>
            <div class="text-[10px] flex items-center gap-2 ${a.status === 'online' ? 'text-green-500' : 'text-red-500'}">
              <span class="w-2 h-2 rounded-full ${a.status === 'online' ? 'bg-green-500 animate-pulse' : 'bg-red-500'}"></span>
              ${a.status.toUpperCase()}
            </div>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between text-[10px] border-b border-zinc-800 pb-2">
              <span class="text-zinc-600">LAST_HEARTBEAT</span>
              <span class="font-mono text-zinc-400">${new Date(a.last_seen).toLocaleTimeString()}</span>
            </div>
            <div class="bg-black/40 p-2 rounded border border-zinc-800/50">
              <div class="text-[9px] text-zinc-600 mb-1 uppercase tracking-wider flex justify-between">
                <span>Resources</span>
                <span class="text-zinc-800 text-[8px]">v${a.specs.version || '??'}</span>
              </div>
              <div class="grid grid-cols-2 gap-2 text-[10px] font-mono">
                <div>CPU: <span class="text-zinc-300">${(a.specs && a.specs.cpu_percent) || 0}%</span></div>
                <div>RAM: <span class="text-zinc-300">${(a.specs && a.specs.ram_percent) || 0}%</span></div>
              </div>
            </div>
            ${(a.sessions && a.sessions.length > 0) ? `
              <div class="mt-2">
                <div class="text-[9px] text-zinc-500 mb-1 uppercase tracking-wider">Sessions</div>
                <div class="flex flex-wrap gap-1">
                  ${a.sessions.map(s => `<span class="text-[9px] text-zinc-400 bg-zinc-950 border border-zinc-800 px-2 py-0.5 rounded truncate max-w-[100px]">${s.id || s}</span>`).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
        <div class="mt-5 pt-4 border-t border-zinc-800 flex justify-end">
          <button class="agent-actions text-[10px] font-bold text-black bg-zinc-200 hover:bg-white px-3 py-1.5 rounded uppercase tracking-wider transition-colors shadow-sm">
            Manage Agent
          </button>
        </div>
      </div>
    `).join('');

    document.querySelectorAll('.agent-actions').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const card = e.target.closest('[data-agent-id]');
        if (!card) return;
        const agentId = card.dataset.agentId;
        if (!agentId) return;
        openAgentModal(agentId);
      });
    });
  }

  const roomList = document.getElementById('room-list');
  let roomsHtml = `<button onclick="selectRoom('all')" class="chat-room ${currentRoom === 'all' ? 'active' : ''} w-full text-left px-4 py-3 text-xs text-zinc-300 hover:bg-zinc-800 border-b border-zinc-800/50"># BROADCAST_ALL</button>`;

  agents.forEach(a => {
    if (a.id !== 'master-ui') {
      // Escape single quotes in agent ID for the onclick attribute
      const escapedId = a.id.replace(/'/g, "\\'");
      roomsHtml += `<button onclick="selectRoom('${escapedId}')" class="chat-room ${currentRoom === a.id ? 'active' : ''} w-full text-left px-4 py-3 text-xs text-zinc-400 hover:bg-zinc-800 border-b border-zinc-800/50 flex justify-between">
        <span>@ ${a.id}</span>
        <span class="w-1.5 h-1.5 rounded-full ${a.status === 'online' ? 'bg-green-500' : 'bg-zinc-600'}"></span>
      </button>`;
    }
  });
  roomList.innerHTML = roomsHtml;
}

function updateTargetOptions(agents) {
  const targets = [document.getElementById('ops-target')].filter(Boolean);
  targets.forEach(select => {
    const current = select.value;
    select.innerHTML = '<option value="all">Broadcast (all)</option>';
    agents.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = a.id;
      select.appendChild(opt);
    });
    if (current) select.value = current;
  });
}

async function approveClient(agentId) {
  if (!confirm(`Approve client ${agentId}?`)) return;
  try {
    const res = await fetch('/api/client/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentId })
    });
    const data = await res.json();
    if (data.success) {
      handlePendingClientsUpdate(data.pendingClients);
      showToast(`Client ${agentId} approved successfully.`, 'success');
    } else {
      showToast('Failed to approve client.', 'error');
    }
  } catch (e) {
    console.error(e);
    showToast('Network error while approving client.', 'error');
  }
}

async function denyClient(agentId) {
  if (!confirm(`Deny client ${agentId}?`)) return;
  try {
    const res = await fetch('/api/client/deny', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agentId })
    });
    const data = await res.json();
    if (data.success) {
      handlePendingClientsUpdate(data.pendingClients);
      showToast(`Client ${agentId} denied.`, 'warning');
    } else {
      showToast('Failed to deny client.', 'error');
    }
  } catch (e) {
    console.error(e);
    showToast('Network error while denying client.', 'error');
  }
}

function handlePendingClientsUpdate(pendingClients) {
  const section = document.getElementById('pending-clients-section');
  const list = document.getElementById('pending-clients-list');
  if (!section || !list) return;

  if (pendingClients && pendingClients.length > 0) {
    section.classList.remove('hidden');
    list.innerHTML = pendingClients.map(c => `
      <div class="flex justify-between items-center bg-black/40 p-3 rounded border border-zinc-800">
        <span class="text-xs font-mono text-zinc-300">${c.agentId}</span>
        <div class="space-x-2">
          <button onclick="approveClient('${c.agentId}')" class="bg-green-600 hover:bg-green-500 text-black text-[9px] font-bold px-2 py-1 rounded uppercase">Approve</button>
          <button onclick="denyClient('${c.agentId}')" class="bg-red-600 hover:bg-red-500 text-black text-[9px] font-bold px-2 py-1 rounded uppercase">Deny</button>
        </div>
      </div>
    `).join('');
  } else {
    section.classList.add('hidden');
    list.innerHTML = '';
  }
}

function handleConnectionEventsUpdate(events) {
  const list = document.getElementById('connection-events-list');
  if (!list) return;

  if (events && events.length > 0) {
    list.innerHTML = events.slice().reverse().slice(0, 20).map(e => `
      <div class="flex justify-between items-center bg-black/40 p-2 rounded border border-zinc-800/50">
        <span class="text-[10px] font-mono ${e.type === 'connect' ? 'text-green-500' : 'text-red-500'}">
          ${e.type === 'connect' ? '[CONNECTED]' : '[DISCONNECTED]'}
        </span>
        <span class="text-[10px] text-zinc-400 font-mono">${e.agentId}</span>
        <span class="text-[9px] text-zinc-600">${new Date(e.timestamp).toLocaleTimeString()}</span>
      </div>
    `).join('');
  } else {
    list.innerHTML = '<div class="text-[10px] text-zinc-600 italic text-center p-2">No recent connection events</div>';
  }
}
</script>
