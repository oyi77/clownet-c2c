<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAWNET_C2C_HQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&display=swap');

        body {
            font-family: 'Fira Code', monospace;
            scrollbar-width: thin;
            scrollbar-color: #27272a #09090b;
            overflow: hidden;
        }

        .terminal-glow {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.1);
        }

        .tab-btn.active {
            border-bottom-color: #22c55e;
            color: #f4f4f5;
            background: #18181b;
        }

        .channel-item.active {
            background: #18181b;
            border-left: 2px solid #22c55e;
        }

        .member-item {
            transition: opacity 200ms ease;
        }

        .message-in {
            animation: message-in 180ms ease-out;
        }

        .typing-caret {
            display: inline-block;
            width: 6px;
            height: 12px;
            margin-left: 2px;
            background: #22c55e;
            animation: caret-blink 1s step-end infinite;
        }

        .typing-dots {
            display: inline-flex;
            gap: 3px;
            margin-left: 6px;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            border-radius: 9999px;
            background: #22c55e;
            opacity: 0.25;
            animation: dot-pulse 1.2s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes message-in {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes caret-blink {

            0%,
            60% {
                opacity: 1;
            }

            61%,
            100% {
                opacity: 0;
            }
        }

        @keyframes dot-pulse {

            0%,
            80%,
            100% {
                opacity: 0.25;
                transform: translateY(0);
            }

            40% {
                opacity: 1;
                transform: translateY(-1px);
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            color: #eee;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 12px;
            min-width: 250px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success { border-left: 4px solid #22c55e; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.info { border-left: 4px solid #3b82f6; }
        .toast.warning { border-left: 4px solid #f59e0b; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(20px); }
        }
    </style>
</head>

<body class="bg-[#09090b] text-zinc-400 min-h-screen flex flex-col overflow-hidden">

    <!-- BLOCKING LOGIN MODAL -->
    <div id="login-overlay" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[9999] hidden">
        <div
            class="terminal-glow bg-[#0c0c0e] border border-zinc-700 rounded-lg p-8 max-w-md w-full mx-4 relative overflow-hidden">
            <div
                class="absolute inset-0 pointer-events-none opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwIiAvPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSIxIiBmaWxsPSIjMzMzIiAvPgo8L3N2Zz4=')]">
            </div>
            <h2 class="text-green-500 text-2xl font-bold mb-6 tracking-tighter flex items-center gap-3">
                <span class="text-red-500 animate-pulse">üîí</span> ACCESS_CONTROL
            </h2>
            <div class="space-y-4 text-sm relative z-10">
                <p id="login-message" class="text-zinc-400 font-mono text-xs uppercase tracking-wider">Authentication
                    Required</p>
                <form id="login-form" class="space-y-4">
                    <input type="password" id="access-code-input" placeholder="ENTER_ACCESS_CODE"
                        class="w-full bg-black/50 border border-zinc-800 rounded p-4 text-center text-green-500 font-mono text-lg tracking-[0.2em] focus:border-green-600 outline-none transition-all focus:ring-1 focus:ring-green-900 placeholder:text-zinc-700"
                        autocomplete="off" autocapitalize="off">
                    <button type="submit" id="login-submit"
                        class="w-full bg-green-600/90 hover:bg-green-500 py-3 rounded text-black font-bold uppercase tracking-widest transition-all transform active:scale-95 shadow-[0_0_15px_rgba(34,197,94,0.3)] hover:shadow-[0_0_25px_rgba(34,197,94,0.5)]">
                        AUTHENTICATE
                    </button>
                </form>
                <div class="text-[10px] text-zinc-600 text-center font-mono mt-4">SECURE CONNECTION // CLAWNET_V3.5
                </div>
            </div>
        </div>
    </div>

    <header
        class="border-b border-zinc-800 p-4 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 bg-[#09090b] z-20">
        <h1 class="text-green-500 font-bold tracking-tighter text-xl italic">ü¶û CLAWNET_C2C <span
                class="text-zinc-600 text-[10px] font-mono not-italic ml-2 tracking-widest">v3.5_WAR_ROOM</span></h1>
        <div id="connection-status" class="flex items-center gap-2 text-[10px] uppercase tracking-widest text-zinc-500">
            <span id="status-dot" class="w-2 h-2 bg-red-500 rounded-full"></span> <span
                id="status-text">CONNECTING...</span>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="w-64 border-r border-zinc-800 bg-[#0c0c0e] flex-col hidden lg:flex z-10">
            <nav class="flex-1 p-4 space-y-2">
                <div class="text-[9px] text-zinc-600 uppercase tracking-[0.2em] mb-4 mt-2 px-2">Main Navigation</div>
                <button onclick="showTab('fleet')"
                    class="tab-btn active w-full text-left px-4 py-3 text-[10px] font-bold rounded border border-transparent hover:border-zinc-800 hover:bg-zinc-900/50 transition-all flex items-center gap-3"
                    data-tab="fleet">
                    <span class="text-zinc-600">01</span> üö¢ FLEET_COMMAND
                </button>
                <button onclick="showTab('ops')"
                    class="tab-btn w-full text-left px-4 py-3 text-[10px] font-bold rounded border border-transparent hover:border-zinc-800 hover:bg-zinc-900/50 transition-all flex items-center gap-3"
                    data-tab="ops">
                    <span class="text-zinc-600">02</span> ‚ö° OPERATIONS
                </button>
                <button onclick="showTab('overview')"
                    class="tab-btn w-full text-left px-4 py-3 text-[10px] font-bold rounded border border-transparent hover:border-zinc-800 hover:bg-zinc-900/50 transition-all flex items-center gap-3"
                    data-tab="overview">
                    <span class="text-zinc-600">06</span> üìä OVERVIEW
                </button>
                <button onclick="showTab('intel')"
                    class="tab-btn w-full text-left px-4 py-3 text-[10px] font-bold rounded border border-transparent hover:border-zinc-800 hover:bg-zinc-900/50 transition-all flex items-center gap-3"
                    data-tab="intel">
                    <span class="text-zinc-600">03</span> üõ∞Ô∏è INTEL_WAR_ROOM
                </button>
                <div class="text-[9px] text-zinc-600 uppercase tracking-[0.2em] mb-4 mt-6 px-2">Configuration</div>
                <button onclick="showTab('settings')"
                    class="tab-btn w-full text-left px-4 py-3 text-[10px] font-bold rounded border border-transparent hover:border-zinc-800 hover:bg-zinc-900/50 transition-all flex items-center gap-3"
                    data-tab="settings">
                    <span class="text-zinc-600">04</span> ‚öôÔ∏è SETTINGS
                </button>
                <button onclick="showTab('logs')"
                    class="tab-btn w-full text-left px-4 py-3 text-[10px] font-bold rounded border border-transparent hover:border-zinc-800 hover:bg-zinc-900/50 transition-all flex items-center gap-3"
                    data-tab="logs">
                    <span class="text-zinc-600">05</span> üìú SYSTEM_LOGS
                </button>
                <button onclick="showTab('docs')"
                    class="tab-btn w-full text-left px-4 py-3 text-[10px] font-bold rounded border border-green-900/30 bg-green-900/5 hover:bg-green-900/10 text-green-500 transition-all flex items-center gap-3 mt-4"
                    data-tab="docs">
                    <span class="text-green-800">06</span> üìñ DOCUMENTATION
                </button>
            </nav>
            <div class="p-6 border-t border-zinc-900 bg-black/20">
                <div class="text-[9px] text-zinc-600 font-mono uppercase tracking-widest mb-1">HQ_STATUS</div>
                <div class="text-[10px] text-green-600 font-mono flex items-center gap-2">
                    <span class="animate-pulse">‚óè</span> ENCRYPTED_LINK_ACTIVE
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 bg-black/20 relative">
            <!-- MOBILE NAV -->
            <nav class="lg:hidden flex border-b border-zinc-800 bg-[#0c0c0e] overflow-x-auto no-scrollbar z-10">
                <button onclick="showTab('fleet')"
                    class="tab-btn active px-6 py-3 text-[10px] font-bold border-r border-zinc-800 hover:bg-zinc-900 transition-all whitespace-nowrap"
                    data-tab="fleet">üö¢ FLEET</button>
                <button onclick="showTab('ops')"
                    class="tab-btn px-6 py-3 text-[10px] font-bold border-r border-zinc-800 hover:bg-zinc-900 transition-all whitespace-nowrap"
                    data-tab="ops">‚ö° OPS</button>
                <button onclick="showTab('overview')"
                    class="tab-btn px-6 py-3 text-[10px] font-bold border-r border-zinc-800 hover:bg-zinc-900 transition-all whitespace-nowrap"
                    data-tab="overview">üìä OVERVIEW</button>
                <button onclick="showTab('intel')"
                    class="tab-btn px-6 py-3 text-[10px] font-bold border-r border-zinc-800 hover:bg-zinc-900 transition-all whitespace-nowrap"
                    data-tab="intel">üõ∞Ô∏è INTEL</button>
                <button onclick="showTab('docs')"
                    class="tab-btn px-6 py-3 text-[10px] font-bold hover:bg-zinc-900 transition-all whitespace-nowrap text-green-500"
                    data-tab="docs">üìñ DOCS</button>
            </nav>

            <div class="flex-1 overflow-hidden relative">
                <!-- DOCS TAB -->
                <section id="docs" class="tab-content h-full p-6 overflow-y-auto hidden">
                    <div class="max-w-4xl mx-auto space-y-8 pb-20">
                        <div class="bg-zinc-900/50 border border-zinc-800 p-8 rounded-lg terminal-glow">
                            <h2 class="text-green-500 text-2xl font-bold mb-6 tracking-tighter flex items-center gap-3">
                                <span class="bg-green-500/10 p-2 rounded">üìñ</span> SYSTEM_DOCUMENTATION
                            </h2>
                            <p class="text-zinc-400 text-sm mb-8 leading-relaxed">ClawNet C2C setup reference for operators and LLM agents. This tab intentionally contains only Connection and LLM Instructions.</p>

                            <div class="space-y-6">
                                <div class="space-y-4">
                                    <h3 class="text-zinc-100 font-bold text-xs uppercase tracking-[0.2em] border-b border-zinc-800 pb-3 flex items-center gap-2">
                                        <span class="w-1 h-1 bg-green-500 rounded-full"></span> 01_CONNECTION
                                    </h3>
                                    <div class="bg-black/60 p-5 rounded border border-zinc-800 space-y-4 shadow-inner">
                                        <div>
                                            <div class="text-[9px] text-zinc-600 uppercase font-bold mb-1.5 tracking-wider">Relay Server URL</div>
                                            <div class="flex gap-2">
                                                <code class="flex-1 text-[11px] text-green-400 font-mono bg-zinc-950 p-2 rounded border border-zinc-900 truncate"><%= serverUrl %></code>
                                                <button onclick="copyToClipboard('<%= serverUrl %>')" class="text-[9px] bg-zinc-800 hover:bg-zinc-700 px-2 rounded">COPY</button>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="text-[9px] text-zinc-600 uppercase font-bold mb-1.5 tracking-wider">Access Token</div>
                                            <div class="flex gap-2">
                                                <code class="flex-1 text-[11px] text-red-400 font-mono bg-zinc-950 p-2 rounded border border-zinc-900 truncate"><%= secret %></code>
                                                <button onclick="copyToClipboard('<%= secret %>')" class="text-[9px] bg-zinc-800 hover:bg-zinc-700 px-2 rounded">COPY</button>
                                            </div>
                                        </div>
                                        <div class="text-[10px] text-zinc-500 leading-relaxed border-t border-zinc-800 pt-3">
                                            Keep token secret. Rotate from Settings when needed. If rotated, restart relay and reconnect agents with the new token.
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <h3 class="text-zinc-100 font-bold text-xs uppercase tracking-[0.2em] border-b border-zinc-800 pb-3 flex items-center gap-2">
                                        <span class="w-1 h-1 bg-green-500 rounded-full"></span> 02_LLM_INSTRUCTIONS
                                    </h3>
                                    <div class="bg-black/60 p-5 rounded border border-zinc-800 space-y-4">
                                        <p class="text-[11px] text-zinc-400 leading-relaxed">Use this structure for LLM prompts. Canonical reference: <code class="text-green-400">LLM.md</code>.</p>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div class="bg-zinc-950/60 border border-zinc-800 rounded p-3">
                                                <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">1) Install</div>
                                                <p class="text-[10px] text-zinc-400 mb-2">Clone repo and install dependencies on the target node.</p>
                                                <div class="relative group">
                                                    <code class="block text-[10px] text-zinc-300 font-mono bg-black/70 p-2 rounded border border-zinc-900 break-all">git clone https://github.com/oyi77/clownet-c2c.git && cd clownet-c2c && npm install</code>
                                                    <button onclick="copyToClipboard('git clone https://github.com/oyi77/clownet-c2c.git && cd clownet-c2c && npm install')" class="absolute top-1.5 right-1.5 bg-zinc-800 hover:bg-zinc-700 px-2 py-1 rounded text-[9px] opacity-0 group-hover:opacity-100 transition-opacity">COPY</button>
                                                </div>
                                            </div>

                                            <div class="bg-zinc-950/60 border border-zinc-800 rounded p-3">
                                                <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">2) Connect</div>
                                                <p class="text-[10px] text-zinc-400 mb-2">Set relay URL and auth token, then define identity.</p>
                                                <div class="relative group">
                                                    <code class="block text-[10px] text-zinc-300 font-mono bg-black/70 p-2 rounded border border-zinc-900 break-all">export CLAWNET_SERVER="<%= serverUrl %>" && export CLAWNET_SECRET_KEY="<%= secret %>" && export AGENT_ROLE="worker" && export AGENT_ID="node-$(hostname)-$(date +%s)"</code>
                                                    <button onclick="copyToClipboard('export CLAWNET_SERVER=\"<%= serverUrl %>\" && export CLAWNET_SECRET_KEY=\"<%= secret %>\" && export AGENT_ROLE=\"worker\" && export AGENT_ID=\"node-$(hostname)-$(date +%s)\"')" class="absolute top-1.5 right-1.5 bg-zinc-800 hover:bg-zinc-700 px-2 py-1 rounded text-[9px] opacity-0 group-hover:opacity-100 transition-opacity">COPY</button>
                                                </div>
                                            </div>

                                            <div class="bg-zinc-950/60 border border-zinc-800 rounded p-3">
                                                <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">3) Auto Update & Restart</div>
                                                <p class="text-[10px] text-zinc-400 mb-2">Use installer for hourly update + reboot persistence. Manual updater available.</p>
                                                <div class="relative group">
                                                    <code class="block text-[10px] text-zinc-300 font-mono bg-black/70 p-2 rounded border border-zinc-900 break-all">./scripts/update.sh</code>
                                                    <button onclick="copyToClipboard('./scripts/update.sh')" class="absolute top-1.5 right-1.5 bg-zinc-800 hover:bg-zinc-700 px-2 py-1 rounded text-[9px] opacity-0 group-hover:opacity-100 transition-opacity">COPY</button>
                                                </div>
                                            </div>

                                            <div class="bg-zinc-950/60 border border-zinc-800 rounded p-3">
                                                <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">4) Run</div>
                                                <p class="text-[10px] text-zinc-400 mb-2">Start relay on server, then start agent sidecar on node.</p>
                                                <div class="relative group">
                                                    <code class="block text-[10px] text-zinc-300 font-mono bg-black/70 p-2 rounded border border-zinc-900 break-all">npm start && node client.js</code>
                                                    <button onclick="copyToClipboard('npm start && node client.js')" class="absolute top-1.5 right-1.5 bg-zinc-800 hover:bg-zinc-700 px-2 py-1 rounded text-[9px] opacity-0 group-hover:opacity-100 transition-opacity">COPY</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-zinc-950/60 border border-zinc-800 rounded p-3 space-y-2">
                                            <div class="text-[10px] uppercase tracking-widest text-zinc-500">5) Included Capabilities</div>
                                            <p class="text-[10px] text-zinc-400 leading-relaxed">Remote command skills available through sidecar: <code>/exec</code>, <code>/update</code>, <code>/restart</code>, <code>/join</code>, telemetry heartbeat, room chat, task ACK/result callbacks.</p>
                                            <div class="relative group">
                                                <pre class="bg-black/70 p-2 rounded border border-zinc-900 text-[10px] text-zinc-300 break-all">Prompt template: Install clownet-c2c agent, connect to <%= serverUrl %> using token <%= secret %>, enable auto-update and reboot persistence, run node client.js as worker, then confirm heartbeat in fleet dashboard.</pre>
                                                <button onclick="copyToClipboard('Install clownet-c2c agent, connect to <%= serverUrl %> using token <%= secret %>, enable auto-update and reboot persistence, run node client.js as worker, then confirm heartbeat in fleet dashboard.')" class="absolute top-1.5 right-1.5 bg-zinc-800 hover:bg-zinc-700 px-2 py-1 rounded text-[9px] opacity-0 group-hover:opacity-100 transition-opacity">COPY</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- FLEET TAB -->
        <section id="fleet" class="tab-content h-full p-6 overflow-y-auto">
            <div id="fleet-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Initial render from server -->
                <% if (agents && agents.length > 0) { %>
                    <% agents.forEach(agent => { %>
                        <div class="bg-zinc-900 border border-zinc-800 p-5 rounded terminal-glow relative group flex flex-col justify-between"
                            data-agent-id="<%= agent.id %>">
                            <div>
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-zinc-100 font-bold text-lg mb-1">
                                            <%= agent.id %>
                                        </h3>
                                        <div class="text-[10px] text-zinc-500 tracking-widest font-mono">ROLE: <span
                                                class="text-zinc-300">
                                                <%= agent.role.toUpperCase() %>
                                            </span></div>
                                    </div>
                                    <div
                                        class="text-[10px] flex items-center gap-2 <%= agent.status === 'online' ? 'text-green-500' : 'text-red-500' %>">
                                        <span
                                            class="w-2 h-2 rounded-full <%= agent.status === 'online' ? 'bg-green-500 animate-pulse' : 'bg-red-500' %>"></span>
                                        <%= agent.status.toUpperCase() %>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between text-[10px] border-b border-zinc-800 pb-2">
                                        <span class="text-zinc-600">LAST_HEARTBEAT</span>
                                        <span class="font-mono text-zinc-400">
                                            <%= new Date(agent.last_seen).toLocaleTimeString() %>
                                        </span>
                                    </div>
                                    <div class="bg-black/40 p-2 rounded border border-zinc-800/50">
                                        <div class="text-[9px] text-zinc-600 mb-1 uppercase tracking-wider flex justify-between">
                                            <span>Resources</span>
                                            <span class="text-zinc-800 text-[8px]">v<%= agent.specs.version || '??' %></span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 text-[10px] font-mono">
                                            <div>CPU: <span class="text-zinc-300">
                                                    <%= (agent.specs && agent.specs.cpu_percent) || 0 %>%
                                                </span></div>
                                            <div>RAM: <span class="text-zinc-300">
                                                    <%= (agent.specs && agent.specs.ram_percent) || 0 %>%
                                                </span></div>
                                        </div>
                                    </div>
                                    <% if (agent.sessions && agent.sessions.length > 0) { %>
                                        <div class="mt-2">
                                            <div class="text-[9px] text-zinc-500 mb-1 uppercase tracking-wider">Sessions
                                            </div>
                                            <div class="flex flex-wrap gap-1">
                                                <% agent.sessions.forEach(s => { %>
                                                    <span
                                                        class="text-[9px] text-zinc-400 bg-zinc-950 border border-zinc-800 px-2 py-0.5 rounded truncate max-w-[100px]">
                                                        <%= s.id || s %>
                                                    </span>
                                                    <% }); %>
                                            </div>
                                        </div>
                                        <% } %>
                                </div>
                            </div>
                            <div class="mt-5 pt-4 border-t border-zinc-800 flex justify-end">
                                <button
                                    class="agent-actions text-[10px] font-bold text-black bg-zinc-200 hover:bg-white px-3 py-1.5 rounded uppercase tracking-wider transition-colors shadow-sm">
                                    Manage Agent
                                </button>
                            </div>
                        </div>
                        <% }); %>
                            <% } else { %>
                                <div class="col-span-3 text-center py-20 text-zinc-600">
                                    <div class="animate-pulse">SCANNING_NETWORK_FREQUENCIES...</div>
                                    <div class="text-xs mt-2">Waiting for agents to report in.</div>
                                </div>
                                <% } %>
            </div>
        </section>

        <!-- OPERATIONS TAB -->
        <section id="ops" class="tab-content h-full p-6 overflow-y-auto hidden">
            <!-- ... existing content ... -->
        </section>

        <!-- OVERVIEW TAB -->
        <section id="overview" class="tab-content h-full p-6 overflow-y-auto hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-zinc-900 border border-zinc-800 p-6 rounded text-center">
                    <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Total Tasks</div>
                    <div id="metric-tasks" class="text-3xl font-bold text-zinc-100">0</div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 p-6 rounded text-center">
                    <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Success Rate</div>
                    <div id="metric-success" class="text-3xl font-bold text-green-500">0%</div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 p-6 rounded text-center">
                    <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Messages</div>
                    <div id="metric-messages" class="text-3xl font-bold text-zinc-100">0</div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 p-6 rounded text-center">
                    <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Online Agents</div>
                    <div id="metric-agents" class="text-3xl font-bold text-zinc-100">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Task Success Rate Chart -->
                <div class="bg-zinc-900 border border-zinc-800 rounded p-4">
                    <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-4">Task Success Rate</div>
                    <div class="relative h-64">
                        <canvas id="chart-success-rate"></canvas>
                    </div>
                </div>

                <!-- Task Volume Chart -->
                <div class="bg-zinc-900 border border-zinc-800 rounded p-4">
                    <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-4">Task Volume (Last 7 Days)</div>
                    <div class="relative h-64">
                        <canvas id="chart-volume"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-zinc-900/50 border border-zinc-800 rounded p-6">
                <div class="text-[10px] uppercase tracking-widest text-zinc-500 mb-4">System Status</div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center p-2 bg-black/40 rounded">
                        <span class="text-xs text-zinc-400">Database Connection</span>
                        <span class="text-[10px] text-green-500 font-bold">CONNECTED</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-black/40 rounded">
                        <span class="text-xs text-zinc-400">WebSocket Server</span>
                        <span class="text-[10px] text-green-500 font-bold">ACTIVE</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-black/40 rounded">
                        <span class="text-xs text-zinc-400">Uptime</span>
                        <span id="metric-uptime" class="text-[10px] text-zinc-300 font-mono">Calculating...</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- INTEL TAB (WAR ROOM) -->
        <section id="intel" class="tab-content h-full hidden flex">
            <!-- Col 1: Channels & DMs -->
            <div class="w-64 border-r border-zinc-800 bg-[#0c0c0e] flex flex-col">
                <div
                    class="p-3 border-b border-zinc-800 text-[10px] uppercase font-bold text-zinc-500 flex justify-between items-center">
                    <span>Channels</span>
                    <button onclick="joinNewRoom()" class="text-green-500 hover:text-green-400">+</button>
                </div>
                <div id="room-list" class="flex-1 overflow-y-auto">
                    <button onclick="selectRoom('all')"
                        class="channel-item active w-full text-left px-4 py-3 text-xs text-zinc-300 hover:bg-zinc-800 border-b border-zinc-800/50">
                        # BROADCAST_ALL
                    </button>
                </div>
                <div class="p-3 border-t border-b border-zinc-800 text-[10px] uppercase font-bold text-zinc-500">
                    Direct_Messages</div>
                <div id="dm-list" class="h-48 overflow-y-auto"></div>
            </div>

            <!-- Col 2: Chat Box -->
            <div class="flex-1 flex flex-col bg-[#09090b]">
                <div id="chat-header"
                    class="p-3 border-b border-zinc-800 text-xs font-bold text-green-500 bg-zinc-900/50 flex justify-between">
                    <span id="chat-title"># BROADCAST_ALL</span>
                    <span id="chat-topic" class="text-[10px] text-zinc-600 font-normal">SECURE_CHANNEL</span>
                </div>
                <div id="chat-box" class="flex-1 p-4 font-mono text-[11px] overflow-y-auto space-y-2"></div>

                <!-- Traffic Feed Overlay (Conditional) -->
                <div id="traffic-feed" class="h-24 border-t border-zinc-800 bg-black/40 overflow-hidden hidden">
                    <div
                        class="p-1 px-3 text-[8px] text-zinc-600 uppercase border-b border-zinc-900 bg-zinc-950 flex justify-between">
                        <span>Traffic Monitor</span>
                        <span id="traffic-status" class="animate-pulse text-red-900">‚óè LIVE</span>
                    </div>
                    <div id="traffic-lines" class="p-2 space-y-0.5 font-mono text-[9px] overflow-y-auto h-full"></div>
                </div>

                <div id="typing-indicator" class="px-4 pb-2 text-[10px] text-zinc-600 h-4"></div>
                <div class="p-3 border-t border-zinc-800 bg-[#0c0c0e]">
                    <input type="text" id="master-input" placeholder="Broadcast message (or /exec command)..."
                        class="w-full bg-black border border-zinc-800 rounded px-4 py-2 text-xs outline-none focus:border-green-600 text-zinc-100 font-mono">
                </div>
            </div>

            <!-- Col 3: Room Members -->
            <div class="w-48 border-l border-zinc-800 bg-[#0c0c0e] flex flex-col hidden sm:flex">
                <div class="p-3 border-b border-zinc-800 text-[10px] uppercase font-bold text-zinc-500">Members</div>
                <div id="member-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                    <div class="text-[10px] text-zinc-700 italic text-center mt-4">No room selected</div>
                </div>
            </div>

            <!-- Col 4: Connection Events -->
            <div class="w-64 border-l border-zinc-800 bg-[#0c0c0e] flex flex-col">
                <div class="p-3 border-b border-zinc-800 text-[10px] uppercase font-bold text-zinc-500 flex justify-between items-center">
                    <span>Connection Events</span>
                </div>
                <div id="connection-events-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                    <div class="text-[10px] text-zinc-600 italic text-center mt-4">Waiting for events...</div>
                </div>
            </div>
        </section>

        <!-- SETTINGS TAB -->
        <section id="settings" class="tab-content h-full p-6 overflow-y-auto hidden">
            <form class="max-w-md bg-zinc-900 border border-zinc-800 p-6 rounded mb-6" method="POST" action="/api/settings">
                <h3 class="text-zinc-100 font-bold mb-4 uppercase text-sm tracking-widest">Database_Config</h3>
                <div class="space-y-4">
                    <input name="supabase_url" type="text" placeholder="Supabase URL"
                        value="<%= settings.supabase_url || '' %>"
                        class="w-full bg-black border border-zinc-800 rounded p-2 text-xs outline-none">
                    <input name="supabase_key" type="password" placeholder="Service Key"
                        value="<%= settings.supabase_key || '' %>"
                        class="w-full bg-black border border-zinc-800 rounded p-2 text-xs outline-none">
                    <button type="submit"
                        class="w-full bg-green-600 py-2 rounded text-[10px] font-bold text-black uppercase">Save_State</button>
                </div>
            </form>

            <!-- Token Configuration -->
            <div class="max-w-md bg-zinc-900 border border-zinc-800 p-6 rounded mb-6">
                <h3 class="text-zinc-100 font-bold mb-4 uppercase text-sm tracking-widest">Access Token</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2 block">Current Token</label>
                        <div class="flex gap-2">
                            <input type="text" id="current-token" value="<%= secret %>" readonly
                                class="flex-1 bg-black border border-zinc-800 rounded p-2 text-xs font-mono text-zinc-400 outline-none">
                            <button onclick="copyCurrentToken()" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-3 py-2 rounded text-[10px] uppercase">Copy</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2 block">New Token</label>
                        <input type="text" id="new-token" placeholder="Minimum 8 characters"
                            class="w-full bg-black border border-zinc-800 rounded p-2 text-xs font-mono text-zinc-100 outline-none focus:border-green-600">
                    </div>
                    <button onclick="rotateToken()" id="rotate-token-btn"
                        class="w-full bg-red-600 hover:bg-red-500 py-2 rounded text-[10px] font-bold text-black uppercase">Rotate Token</button>
                    <p class="text-[9px] text-zinc-500">Token change requires server restart to take effect.</p>
                </div>

                <div class="mt-4 pt-4 border-t border-zinc-800">
                    <button onclick="restartServer()" id="restart-server-btn"
                        class="w-full bg-yellow-600 hover:bg-yellow-500 py-2 rounded text-[10px] font-bold text-black uppercase">Restart Server</button>
                    <p class="text-[9px] text-zinc-500 mt-1">Sends SIGTERM. Requires process manager (Docker/pm2/systemd) to auto-restart.</p>
                </div>
            </div>

            <!-- Advanced Settings -->
            <form id="advanced-settings-form" class="max-w-md bg-zinc-900 border border-zinc-800 p-6 rounded mb-6">
                <h3 class="text-zinc-100 font-bold mb-4 uppercase text-sm tracking-widest">Client_Security</h3>

                <!-- Client Approval Mode -->
                <div class="mb-4">
                    <label class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2 block">Approval_Mode</label>
                    <select id="approval-mode" name="clientApprovalMode" class="w-full bg-black border border-zinc-800 rounded p-2 text-xs outline-none">
                        <option value="auto" <%= settings.clientApprovalMode === 'auto' ? 'selected' : '' %>>Auto Allow</option>
                        <option value="manual" <%= settings.clientApprovalMode === 'manual' ? 'selected' : '' %>>Manual Approval</option>
                    </select>
                </div>

                <!-- Whitelist -->
                <div class="mb-4">
                    <label class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2 block">Whitelisted_Clients</label>
                    <textarea id="whitelist-input" name="whitelistedClients" rows="3" class="w-full bg-black border border-zinc-800 rounded p-2 text-xs outline-none font-mono" placeholder="Comma separated client IDs"><%= settings.whitelistedClients ? settings.whitelistedClients.join(', ') : '' %></textarea>
                </div>

                <!-- Blacklist -->
                <div class="mb-4">
                    <label class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2 block">Blacklisted_Clients</label>
                    <textarea id="blacklist-input" name="blacklistedClients" rows="3" class="w-full bg-black border border-zinc-800 rounded p-2 text-xs outline-none font-mono" placeholder="Comma separated client IDs"><%= settings.blacklistedClients ? settings.blacklistedClients.join(', ') : '' %></textarea>
                </div>

                <button type="submit" id="save-advanced-settings"
                    class="w-full bg-blue-600 py-2 rounded text-[10px] font-bold text-black uppercase">Save_Security_Settings</button>
            </form>

            <!-- Pending Clients Queue -->
            <div id="pending-clients-section" class="bg-zinc-900 border border-zinc-800 p-6 rounded hidden">
                <h3 class="text-zinc-100 font-bold mb-4 uppercase text-sm tracking-widest">Pending_Approval</h3>
                <div id="pending-clients-list" class="space-y-2">
                    <!-- Populated by JS -->
                    <% if (pendingClients && pendingClients.length > 0) { %>
                        <% pendingClients.forEach(client => { %>
                            <div class="flex justify-between items-center bg-black/40 p-3 rounded border border-zinc-800">
                                <span class="text-xs font-mono text-zinc-300"><%= client.agentId %></span>
                                <div class="space-x-2">
                                    <button onclick="approveClient('<%= client.agentId %>')" class="bg-green-600 hover:bg-green-500 text-black text-[9px] font-bold px-2 py-1 rounded uppercase">Approve</button>
                                    <button onclick="denyClient('<%= client.agentId %>')" class="bg-red-600 hover:bg-red-500 text-black text-[9px] font-bold px-2 py-1 rounded uppercase">Deny</button>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <div class="text-[10px] text-zinc-500 italic">No pending clients.</div>
                    <% } %>
                </div>
            </div>
        </section>

        <!-- LOGS TAB -->
        <section id="logs" class="tab-content h-full p-6 overflow-y-auto hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="bg-zinc-900 border border-zinc-800 rounded p-4 flex flex-col gap-3">
                    <div class="flex items-center justify-between gap-2 mb-2">
                        <div class="text-[10px] uppercase tracking-widest text-zinc-500">Server Logs</div>
                        <input type="text" id="server-logs-search" placeholder="Search logs..." class="bg-black border border-zinc-800 rounded px-2 py-1 text-[10px] outline-none flex-1">
                        <button id="logs-refresh" class="text-[10px] uppercase text-green-500 whitespace-nowrap">Refresh</button>
                    </div>
                    <div id="server-logs"
                        class="h-72 bg-black/50 border border-zinc-800 rounded p-2 text-[10px] font-mono overflow-y-auto">
                    </div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded p-4 flex flex-col gap-3">
                    <div class="flex items-center justify-between gap-2 mb-2">
                        <div class="text-[10px] uppercase tracking-widest text-zinc-500">Client Task Logs</div>
                        <input type="text" id="task-logs-search" placeholder="Search tasks..." class="bg-black border border-zinc-800 rounded px-2 py-1 text-[10px] outline-none flex-1">
                        <button id="task-logs-refresh" class="text-[10px] uppercase text-green-500 whitespace-nowrap">Refresh</button>
                    </div>
                    <div id="task-logs"
                        class="h-72 bg-black/50 border border-zinc-800 rounded p-2 text-[10px] font-mono overflow-y-auto">
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- TASK OUTPUT MODAL -->
    <div id="task-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
        <div
            class="bg-zinc-950 border border-zinc-800 rounded w-full max-w-2xl p-5 max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between mb-4 border-b border-zinc-800 pb-3">
                <div class="text-zinc-100 font-bold">TASK OUTPUT</div>
                <button id="task-modal-close" class="text-zinc-500 text-xs">CLOSE</button>
            </div>
            <div class="space-y-2 text-xs mb-3">
                <div class="flex justify-between"><span class="text-zinc-500">Task ID</span><span id="task-modal-id"
                        class="text-zinc-200 font-mono"></span></div>
                <div class="flex justify-between"><span class="text-zinc-500">Agent</span><span id="task-modal-agent"
                        class="text-zinc-200 font-bold"></span></div>
                <div class="flex justify-between"><span class="text-zinc-500">Command</span><span id="task-modal-cmd"
                        class="text-zinc-200 font-mono"></span></div>
                <div class="flex justify-between"><span class="text-zinc-500">Status</span><span id="task-modal-status"
                        class="text-zinc-200"></span></div>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div id="task-modal-output"
                    class="bg-black/50 border border-zinc-800 rounded p-4 text-[10px] font-mono text-zinc-300 whitespace-pre-wrap break-all">
                </div>
            </div>
        </div>
    </div>

    <!-- AGENT LOGS MODAL -->
    <div id="agent-logs-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
        <div
            class="bg-zinc-950 border border-zinc-800 rounded w-full max-w-2xl p-5 max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between mb-4 border-b border-zinc-800 pb-3">
                <div>
                    <span class="text-zinc-100 font-bold text-xs uppercase tracking-widest">Agent Logs</span>
                    <span class="text-zinc-500 text-[10px] ml-2"><span id="agent-logs-agent-id"></span></span>
                </div>
                <button id="agent-logs-close" class="text-zinc-500 text-xs">CLOSE</button>
            </div>
            <div id="agent-logs-content" class="flex-1 overflow-y-auto space-y-1 text-xs"></div>
        </div>
    </div>

    <!-- AGENT MODAL -->
    <div id="agent-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4">
        <div class="bg-zinc-950 border border-zinc-800 rounded w-full max-w-2xl p-6 max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between mb-6 border-b border-zinc-800 pb-4">
                <div>
                    <h2 class="text-zinc-100 font-bold text-lg uppercase tracking-widest flex items-center gap-2">
                        <span class="text-green-500">‚óè</span> <span id="agent-modal-title">AGENT</span>
                    </h2>
                    <div id="agent-modal-subtitle" class="text-xs text-zinc-500 font-mono mt-1">ID: <span id="agent-modal-id"></span></div>
                </div>
                <button id="agent-modal-close" class="text-zinc-500 text-xs hover:text-zinc-300 uppercase tracking-wider">Close [ESC]</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Status Column -->
                <div class="bg-zinc-900/50 p-4 rounded border border-zinc-800">
                    <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-3">Status</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-zinc-400">Role</span>
                            <span id="agent-modal-role" class="font-bold text-zinc-200"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-400">State</span>
                            <span id="agent-modal-status" class="font-bold text-green-500"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-400">IP Address</span>
                            <span id="agent-modal-ip" class="font-mono text-zinc-300"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-400">Last Seen</span>
                            <span id="agent-modal-last-seen" class="font-mono text-zinc-400"></span>
                        </div>
                    </div>
                </div>

                <!-- Resources Column -->
                <div class="bg-zinc-900/50 p-4 rounded border border-zinc-800">
                    <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-3">Resources</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-zinc-400">CPU</span>
                            <span id="agent-modal-cpu" class="font-bold text-zinc-200"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-400">RAM</span>
                            <span id="agent-modal-ram" class="font-bold text-zinc-200"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-400">Hostname</span>
                            <span id="agent-modal-hostname" class="font-mono text-zinc-300 truncate max-w-[120px]"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-400">Uptime</span>
                            <span id="agent-modal-uptime" class="font-mono text-zinc-400"></span>
                        </div>
                    </div>
                </div>

                <!-- Info Column -->
                <div class="bg-zinc-900/50 p-4 rounded border border-zinc-800">
                    <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-3">Info</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-zinc-400">Version</span>
                            <span id="agent-modal-version" class="font-mono text-zinc-300"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-400">OS</span>
                            <span id="agent-modal-os" class="font-mono text-zinc-300 truncate max-w-[120px]"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-400">Sessions</span>
                            <span id="agent-modal-sessions-count" class="font-bold text-zinc-200"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Tasks -->
            <div class="flex-1 overflow-hidden flex flex-col mb-4">
                <h3 class="text-[10px] uppercase tracking-widest text-zinc-500 mb-2">Recent Tasks</h3>
                <div class="bg-black/40 border border-zinc-800 rounded flex-1 overflow-y-auto max-h-48">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-zinc-900/50 text-zinc-500 sticky top-0">
                            <tr>
                                <th class="p-2 font-normal">Task</th>
                                <th class="p-2 font-normal">Status</th>
                                <th class="p-2 font-normal">Time</th>
                            </tr>
                        </thead>
                        <tbody id="agent-modal-tasks" class="font-mono text-zinc-400 divide-y divide-zinc-800/50">
                            <!-- Tasks injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Actions -->
            <div class="grid grid-cols-2 gap-4 border-t border-zinc-800 pt-4 mt-auto">
                <div class="flex gap-2">
                    <button id="agent-modal-logs" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-200 py-2 rounded text-[10px] font-bold uppercase tracking-wider transition-colors">
                        View Logs
                    </button>
                    <button id="agent-modal-restart" class="flex-1 bg-zinc-800 hover:bg-red-900/50 text-zinc-200 py-2 rounded text-[10px] font-bold uppercase tracking-wider transition-colors">
                        Restart
                    </button>
                </div>
                <div class="flex gap-2">
                    <button id="agent-modal-update" class="flex-1 bg-zinc-800 hover:bg-green-900/50 text-green-500 py-2 rounded text-[10px] font-bold uppercase tracking-wider transition-colors">
                        Update
                    </button>
                    <button id="agent-modal-inspect" class="flex-1 bg-zinc-800 hover:bg-blue-900/50 text-blue-500 py-2 rounded text-[10px] font-bold uppercase tracking-wider transition-colors">
                        Shell
                    </button>
                </div>
            </div>

            <!-- Quick Command -->
            <div class="mt-4 pt-4 border-t border-zinc-800">
                <div class="flex gap-2">
                    <input type="text" id="agent-modal-command" placeholder="/status | /sessions list"
                        class="flex-1 bg-black border border-zinc-800 rounded px-3 py-2 text-xs outline-none focus:border-green-600 text-zinc-100 font-mono">
                    <button id="agent-modal-dispatch"
                        class="bg-green-600 px-4 py-2 rounded text-[10px] font-bold text-black uppercase">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- 1. GLOBAL VARIABLES & ELEMENT REFERENCES ---
        const masterInput = document.getElementById('master-input');
        const opsDispatch = document.getElementById('ops-dispatch');
        const logsRefresh = document.getElementById('logs-refresh');
        const modalClose = document.getElementById('agent-modal-close');
        const modalDispatch = document.getElementById('agent-modal-dispatch');
        const modalRoleApply = document.getElementById('agent-modal-role-apply');

        // --- Toast Notification System ---
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="font-bold">${type.toUpperCase()}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        let currentRoom = 'all';
        let agentsCache = [];
        let tasksCache = [];
        const agentCache = {};
        const chatHistory = {};
        const seenMessageKeys = new Set();
        const seenMessageQueue = [];
        const MAX_SEEN_MESSAGES = 200;
        const activeTypers = new Map();
        const TYPING_TTL_MS = 2000;
        const TYPING_THROTTLE_MS = 800;
        let currentAgentId = null;

        // Initialize tasks cache from server data
        <%
        if (tasks && tasks.length > 0) {
            tasks.forEach(task => {
        %>
                    tasksCache.push({ id: '<%= task.id %>', agent_id: '<%= task.agent_id %>', cmd: '<%= task.cmd %>', status: '<%= task.status %>', result: <%- JSON.stringify(task.result || null) %> });
        <%
            });
        }
        %>

        // --- 2. AUTHENTICATION LOGIC ---
        const secret = '<%= secret %>';
        let token = localStorage.getItem('clawnet_token') || secret;
        let socket = null;

        const modal = document.getElementById('login-overlay');
        const form = document.getElementById('login-form');
        const input = document.getElementById('access-code-input');
        const msg = document.getElementById('login-message');

        function showLogin(message = "Authentication Required") {
            modal.classList.remove('hidden');
            msg.innerText = message;
            msg.classList.add('text-red-400');
            input.value = '';
            input.focus();
        }

        function hideLogin() {
            modal.classList.add('hidden');
        }

        function connectSocket(authToken) {
            if (socket) {
                socket.auth.token = authToken;
                socket.connect();
                return;
            }

            socket = io({
                auth: { token: authToken, agent_id: 'master-ui', role: 'master' },
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 10
            });

            setupSocketListeners();
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
                console.log("‚úÖ Socket connected");
                hideLogin();
                document.getElementById('status-dot').className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                document.getElementById('status-text').innerText = 'ONLINE (' + socket.io.engine.transport.name.toUpperCase() + ')';
                localStorage.setItem('clawnet_token', socket.auth.token);
            });

            socket.on('connect_error', (err) => {
                console.error("Connection Error:", err.message);
                document.getElementById('status-text').innerText = 'AUTH_FAILED';
                document.getElementById('status-dot').className = 'w-2 h-2 bg-red-600 rounded-full';

                if (err.message === 'Unauthorized' || err.message.includes('auth')) {
                    localStorage.removeItem('clawnet_token');
                    showLogin("ACCESS DENIED. INVALID CODE.");
                }
            });

            socket.on('fleet_update', handleFleetUpdate);
            socket.on('task_update', handleTaskUpdate);
            socket.on('chat_update', handleChatUpdate);
            socket.on('typing_update', handleTypingUpdate);
            socket.on('room_update', handleRoomUpdate);
            socket.on('traffic', handleTraffic);
            socket.on('intel_update', appendIntel);
            socket.on('pending_clients_update', handlePendingClientsUpdate);
            socket.on('connection_events_update', handleConnectionEventsUpdate);
        }

        // --- NEW EVENT HANDLERS ---

        function handlePendingClientsUpdate(pendingClients) {
            const section = document.getElementById('pending-clients-section');
            const list = document.getElementById('pending-clients-list');
            if (!section || !list) return;

            if (pendingClients && pendingClients.length > 0) {
                section.classList.remove('hidden');
                list.innerHTML = pendingClients.map(c => `
                    <div class="flex justify-between items-center bg-black/40 p-3 rounded border border-zinc-800">
                        <span class="text-xs font-mono text-zinc-300">${c.agentId}</span>
                        <div class="space-x-2">
                            <button onclick="approveClient('${c.agentId}')" class="bg-green-600 hover:bg-green-500 text-black text-[9px] font-bold px-2 py-1 rounded uppercase">Approve</button>
                            <button onclick="denyClient('${c.agentId}')" class="bg-red-600 hover:bg-red-500 text-black text-[9px] font-bold px-2 py-1 rounded uppercase">Deny</button>
                        </div>
                    </div>
                `).join('');
            } else {
                section.classList.add('hidden');
                list.innerHTML = '';
            }
        }

        function handleConnectionEventsUpdate(events) {
            const list = document.getElementById('connection-events-list');
            if (!list) return;

            if (events && events.length > 0) {
                list.innerHTML = events.slice().reverse().slice(0, 20).map(e => `
                    <div class="flex justify-between items-center bg-black/40 p-2 rounded border border-zinc-800/50">
                        <span class="text-[10px] font-mono ${e.type === 'connect' ? 'text-green-500' : 'text-red-500'}">
                            ${e.type === 'connect' ? '[CONNECTED]' : '[DISCONNECTED]'}
                        </span>
                        <span class="text-[10px] text-zinc-400 font-mono">${e.agentId}</span>
                        <span class="text-[9px] text-zinc-600">${new Date(e.timestamp).toLocaleTimeString()}</span>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<div class="text-[10px] text-zinc-600 italic text-center p-2">No recent connection events</div>';
            }
        }

        async function approveClient(agentId) {
            if (!confirm(`Approve client ${agentId}?`)) return;
            try {
                const res = await fetch('/api/client/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agentId })
                });
                const data = await res.json();
                if (data.success) {
                    handlePendingClientsUpdate(data.pendingClients);
                    showToast(`Client ${agentId} approved successfully.`, 'success');
                } else {
                    showToast('Failed to approve client.', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Network error while approving client.', 'error');
            }
        }

        async function denyClient(agentId) {
            if (!confirm(`Deny client ${agentId}?`)) return;
            try {
                const res = await fetch('/api/client/deny', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agentId })
                });
                const data = await res.json();
                if (data.success) {
                    handlePendingClientsUpdate(data.pendingClients);
                    showToast(`Client ${agentId} denied.`, 'warning');
                } else {
                    showToast('Failed to deny client.', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Network error while denying client.', 'error');
            }
        }

        // Advanced Settings Form
        document.getElementById('advanced-settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const approvalMode = document.getElementById('approval-mode').value;
            const whitelist = document.getElementById('whitelist-input').value.split(',').map(s => s.trim()).filter(Boolean);
            const blacklist = document.getElementById('blacklist-input').value.split(',').map(s => s.trim()).filter(Boolean);

            try {
                const res = await fetch('/api/advanced-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientApprovalMode: approvalMode,
                        whitelistedClients: whitelist,
                        blacklistedClients: blacklist
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Security settings updated successfully.', 'success');
                } else {
                    showToast('Failed to update settings.', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Error updating settings.', 'error');
            }
        });

        // --- 3. INIT AUTH ---
        if (!token) {
            showLogin();
        } else {
            connectSocket(token);
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const code = input.value.trim();
            if (code) {
                msg.innerText = "VERIFYING CREDENTIALS...";
                msg.classList.remove('text-red-400');
                msg.classList.add('text-yellow-400');
                connectSocket(code);
            }
        });

        // --- 4. CORE FUNCTIONS ---

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.createElement('div');
                toast.className = "fixed bottom-4 right-4 bg-green-600 text-black text-[10px] font-bold px-4 py-2 rounded shadow-lg z-[10000] animate-bounce";
                toast.innerText = "COPIED_TO_CLIPBOARD";
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            });
        }

        function copyCurrentToken() {
            const token = document.getElementById('current-token').value;
            copyToClipboard(token);
            showToast('Token copied to clipboard', 'success');
        }

        async function rotateToken() {
            const newToken = document.getElementById('new-token').value.trim();
            if (newToken.length < 8) {
                showToast('Token must be at least 8 characters', 'error');
                return;
            }

            if (!confirm('Rotate access token? This will invalidate the current token. Restart server to apply changes.')) {
                return;
            }

            try {
                const res = await fetch('/api/rotate-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newToken })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    document.getElementById('new-token').value = '';
                } else {
                    showToast(data.error || 'Failed to rotate token', 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function restartServer() {
            if (!confirm('Restart the server? This will disconnect all agents.')) {
                return;
            }

            try {
                const res = await fetch('/api/restart', { method: 'POST' });
                const data = await res.json();
                showToast(data.message || 'Restarting...', 'info');
            } catch (e) {
                showToast('Failed to send restart signal', 'error');
            }
        }

        function handleFleetUpdate(agents) {
            agentsCache = agents;
            const grid = document.getElementById('fleet-grid');
            agents.forEach(a => { agentCache[a.id] = a; });
            updateTargetOptions(agents);

            if (agents.length === 0) {
                grid.innerHTML = '<div class="col-span-3 text-center py-20 text-zinc-600">NO AGENTS ONLINE</div>';
            } else {
                grid.innerHTML = agents.map(a => `
                    <div class="bg-zinc-900 border border-zinc-800 p-5 rounded terminal-glow relative group flex flex-col justify-between" data-agent-id="${a.id}">
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-zinc-100 font-bold text-lg mb-1">${a.id}</h3>
                                    <div class="text-[10px] text-zinc-500 tracking-widest font-mono uppercase">ROLE: <span class="text-zinc-300">${a.role}</span></div>
                                </div>
                                <div class="text-[10px] flex items-center gap-2 ${a.status === 'online' ? 'text-green-500' : 'text-red-500'}">
                                    <span class="w-2 h-2 rounded-full ${a.status === 'online' ? 'bg-green-500 animate-pulse' : 'bg-red-500'}"></span>
                                    ${a.status.toUpperCase()}
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between text-[10px] border-b border-zinc-800 pb-2">
                                    <span class="text-zinc-600">LAST_HEARTBEAT</span>
                                    <span class="font-mono text-zinc-400">${new Date(a.last_seen).toLocaleTimeString()}</span>
                                </div>
                                <div class="bg-black/40 p-2 rounded border border-zinc-800/50">
                                    <div class="text-[9px] text-zinc-600 mb-2 uppercase tracking-wider flex justify-between">
                                        <span>Resources</span>
                                        <span class="text-zinc-800 text-[8px]">v${a.specs.version || '??'}</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-[10px] font-mono">
                                        <div>CPU: <span class="text-zinc-300">${(a.specs && a.specs.cpu_percent) || 0}%</span></div>
                                        <div>RAM: <span class="text-zinc-300">${(a.specs && a.specs.ram_percent) || 0}%</span></div>
                                    </div>
                                </div>
                                ${(a.sessions && a.sessions.length > 0) ? `
                                    <div class="mt-2">
                                        <div class="text-[9px] text-zinc-500 mb-1 uppercase tracking-wider">Sessions</div>
                                        <div class="flex flex-wrap gap-1">
                                            ${a.sessions.map(s => `<span class="text-[9px] text-zinc-400 bg-zinc-950 border border-zinc-800 px-2 py-0.5 rounded truncate max-w-[100px]">${s.id || s}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="mt-5 pt-4 border-t border-zinc-800 flex justify-end">
                            <button class="agent-actions text-[10px] font-bold text-black bg-zinc-200 hover:bg-white px-3 py-1.5 rounded uppercase tracking-wider transition-colors shadow-sm">
                                Manage Agent
                            </button>
                        </div>
                    </div>
                `).join('');

                document.querySelectorAll('.agent-actions').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const card = e.target.closest('[data-agent-id]');
                        if (!card) return;
                        const agentId = card.dataset.agentId;
                        if (!agentId) return;
                        openAgentModal(agentId);
                    });
                });
            }

            const roomList = document.getElementById('room-list');
            let roomsHtml = `<button onclick="selectRoom('all')" class="chat-room ${currentRoom === 'all' ? 'active' : ''} w-full text-left px-4 py-3 text-xs text-zinc-300 hover:bg-zinc-800 border-b border-zinc-800/50"># BROADCAST_ALL</button>`;

            agents.forEach(a => {
                if (a.id !== 'master-ui') {
                    roomsHtml += `<button onclick="selectRoom('${a.id}')" class="chat-room ${currentRoom === a.id ? 'active' : ''} w-full text-left px-4 py-3 text-xs text-zinc-400 hover:bg-zinc-800 border-b border-zinc-800/50 flex justify-between">
                        <span>@ ${a.id}</span>
                        <span class="w-1.5 h-1.5 rounded-full ${a.status === 'online' ? 'bg-green-500' : 'bg-zinc-600'}"></span>
                    </button>`;
                }
            });
            roomList.innerHTML = roomsHtml;
        }

        function handleTaskUpdate(tasks) {
            tasksCache = tasks || [];
            renderOps(tasks);
            refreshLogs();
        }

        function handleChatUpdate(msg) {
            handleChatMessage(msg);
        }

        function handleTypingUpdate(msg) {
            if (!msg || !msg.from) return;
            if (msg.from === 'master-ui') return;
            const key = typingKey(msg);
            if (msg.isTyping) {
                if (activeTypers.has(key)) {
                    clearTimeout(activeTypers.get(key).timeoutId);
                }
                const timeoutId = setTimeout(() => {
                    activeTypers.delete(key);
                    renderTypingIndicator();
                }, TYPING_TTL_MS);
                activeTypers.set(key, { from: msg.from, to: msg.to || 'all', timeoutId });
            } else {
                if (activeTypers.has(key)) {
                    clearTimeout(activeTypers.get(key).timeoutId);
                    activeTypers.delete(key);
                }
            }
            renderTypingIndicator();
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('flex'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            const tab = document.getElementById(id);
            if (tab) {
                tab.classList.remove('hidden');
                if (id === 'intel') tab.classList.add('flex');
                if (id === 'ops') refreshOps();
                if (id === 'overview') loadOverviewMetrics();
            }

            document.querySelectorAll(`[data-tab="${id}"]`).forEach(b => b.classList.add('active'));
            if (id === 'logs') refreshLogs();
        }

        // Overview Metrics Logic
        function loadOverviewMetrics() {
            Promise.all([
                fetch('/api/metrics').then(res => res.json()),
                fetch('/api/info').then(res => res.json())
            ]).then(([metrics, info]) => {
                document.getElementById('metric-tasks').textContent = (metrics.tasks_total || 0).toLocaleString();
                document.getElementById('metric-messages').textContent = (metrics.messages_total || 0).toLocaleString();
                document.getElementById('metric-agents').textContent = (metrics.agents_online || 0).toLocaleString();

                const successRate = metrics.tasks_total > 0
                    ? ((metrics.tasks_success / metrics.tasks_total) * 100).toFixed(1)
                    : 0;
                const failRate = metrics.tasks_total > 0
                    ? ((metrics.tasks_failed / metrics.tasks_total) * 100).toFixed(1)
                    : 0;
                document.getElementById('metric-success').textContent = successRate + '%';

                // Render Charts
                renderSuccessChart(successRate, failRate);
                renderVolumeChart();

                const seconds = Math.floor(info.uptime || 0);
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                document.getElementById('metric-uptime').textContent = `${h}h ${m}m ${s}s`;
            });
        }

        function renderSuccessChart(success, fail) {
            const ctx = document.getElementById('chart-success-rate').getContext('2d');

            // Destroy existing chart if any
            if (window.overviewSuccessChart) window.overviewSuccessChart.destroy();

            window.overviewSuccessChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Success', 'Failed'],
                    datasets: [{
                        data: [success, fail],
                        backgroundColor: [
                            '#22c55e', // Green
                            '#ef4444'  // Red
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#a1a1aa',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        function renderVolumeChart() {
            const ctx = document.getElementById('chart-volume').getContext('2d');

            // Destroy existing chart if any
            if (window.overviewVolumeChart) window.overviewVolumeChart.destroy();

            // Mock data for last 7 days
            const days = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                days.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
                data.push(Math.floor(Math.random() * 50) + 10); // Random data 10-60
            }

            window.overviewVolumeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Tasks',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#27272a'
                            },
                            ticks: {
                                color: '#a1a1aa'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#a1a1aa'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Command Templates Logic
        function refreshOps() {
            fetch('/api/templates')
                .then(res => res.json())
                .then(data => {
                    const grid = document.getElementById('templates-grid');
                    if (data.templates && data.templates.length > 0) {
                        grid.innerHTML = data.templates.map(t => `
                            <div class="bg-black/40 border border-zinc-800 p-3 rounded hover:border-zinc-700 transition-colors group">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="font-bold text-xs text-zinc-200">${t.name}</div>
                                    <button onclick="deleteTemplate('${t.id}')" class="text-[10px] text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
                                </div>
                                <div class="text-[10px] text-zinc-500 font-mono truncate mb-3">${t.command}</div>
                                <button onclick="useTemplate('${t.command.replace(/'/g, "\\'")}')" class="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[9px] py-1 rounded uppercase transition-colors">Use Template</button>
                            </div>
                        `).join('');
                    } else {
                        grid.innerHTML = '<div class="col-span-full text-center py-4 text-zinc-600 text-xs italic">No templates saved.</div>';
                    }
                });
        }

        function useTemplate(cmd) {
            const input = document.getElementById('ops-command');
            input.value = cmd;
            input.focus();
            showToast('Template command copied to input.', 'info');
        }

        function deleteTemplate(id) {
            if (!confirm('Delete this template?')) return;
            fetch(`/api/templates/${id}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        refreshOps();
                        showToast('Template deleted.', 'warning');
                    }
                });
        }

        document.getElementById('add-template-btn')?.addEventListener('click', () => {
            document.getElementById('template-modal').classList.remove('hidden');
            document.getElementById('template-modal').classList.add('flex');
        });

        document.getElementById('template-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'template-modal') {
                document.getElementById('template-modal').classList.add('hidden');
                document.getElementById('template-modal').classList.remove('flex');
            }
        });

        function saveTemplate() {
            const name = document.getElementById('template-name').value;
            const command = document.getElementById('template-command').value;
            if (!name || !command) {
                showToast('Please fill in all fields.', 'error');
                return;
            }

            fetch('/api/templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, command })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('template-modal').classList.add('hidden');
                    document.getElementById('template-modal').classList.remove('flex');
                    document.getElementById('template-name').value = '';
                    document.getElementById('template-command').value = '';
                    refreshOps();
                    showToast('Template saved.', 'success');
                }
            });
        }

        function updateTargetOptions(agents) {
            const targets = [document.getElementById('ops-target')].filter(Boolean);
            targets.forEach(select => {
                const current = select.value;
                select.innerHTML = '<option value="all">Broadcast (all)</option>';
                agents.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.id;
                    opt.textContent = a.id;
                    select.appendChild(opt);
                });
                if (current) select.value = current;
            });
        }

        function renderOps(tasks) {
            const body = document.getElementById('ops-body');
            if (!tasks || tasks.length === 0) {
                body.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-zinc-600 text-xs">NO TASKS</td></tr>';
                return;
            }
            body.innerHTML = tasks.slice().reverse().map(t => {
                const status = (t.status || 'UNKNOWN').toUpperCase();
                const statusClass = status === 'SUCCESS' ? 'text-green-500' : status === 'FAIL' ? 'text-red-500' : 'text-zinc-500';
                const output = t.result && t.result.stdout ? t.result.stdout.substring(0, 60) : (typeof t.result === 'string' ? t.result.substring(0, 60) : '');
                const approvalBtn = status === 'PENDING_APPROVAL' ? `<button onclick="approveTask('${t.id}')" class="bg-green-600 hover:bg-green-500 text-black text-[9px] font-bold px-2 py-1 rounded uppercase">Approve</button>` : '';
                return `
                    <tr class="border-b border-zinc-800/50">
                        <td class="p-4 font-mono text-zinc-600">#${t.id.substring(0, 8)}</td>
                        <td class="p-4 font-bold text-zinc-300">${t.agent_id}</td>
                        <td class="p-4 font-mono text-zinc-500">${t.cmd}</td>
                        <td class="p-4"><span class="text-[9px] font-bold ${statusClass}">${status}</span></td>
                        <td class="p-4 text-[10px] text-zinc-500 font-mono">${output}</td>
                        <td class="p-4">${approvalBtn}</td>
                        <td class="p-4"><button onclick="showTaskOutput('${t.id}')" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[10px] font-bold px-2 py-1 rounded">Log</button></td>
                    </tr>
                `;
            }).join('');
        }

        function approveTask(taskId) {
            if (!confirm('Authorize this risky command?')) return;
            socket.emit('approve_task', { task_id: taskId });
        }

        function appendIntel(entry) {
            if (entry.type === 'chat') {
                const msg = entry.message;
                handleChatMessage(msg);
            }
        }

        function formatTime(ts) {
            const date = ts ? new Date(ts) : new Date();
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function getMessageKey(msg) {
            return `${msg.ts || ''}|${msg.from || ''}|${msg.to || ''}|${msg.msg || ''}`;
        }

        function rememberMessage(key) {
            if (seenMessageKeys.has(key)) return false;
            seenMessageKeys.add(key);
            seenMessageQueue.push(key);
            if (seenMessageQueue.length > MAX_SEEN_MESSAGES) {
                const oldest = seenMessageQueue.shift();
                if (oldest) seenMessageKeys.delete(oldest);
            }
            return true;
        }

        function typeText(container, text, options = {}) {
            const safeText = text || '';
            const maxDuration = 900;
            const minSpeed = 8;
            const maxSpeed = 28;
            const speed = Math.min(maxSpeed, Math.max(minSpeed, Math.floor(maxDuration / Math.max(safeText.length, 1))));
            const caret = document.createElement('span');
            caret.className = 'typing-caret';
            container.textContent = '';
            container.appendChild(caret);

            let index = 0;
            const step = () => {
                if (index < safeText.length) {
                    container.insertBefore(document.createTextNode(safeText[index]), caret);
                    index += 1;
                    if (options.onUpdate) options.onUpdate();
                    setTimeout(step, options.speed || speed);
                } else {
                    caret.remove();
                    if (options.onDone) options.onDone();
                }
            };
            step();
        }

        function addLog(sender, text, isMe, options = {}) {
            const box = document.getElementById('chat-box');
            if (!box) return;

            const msgId = options.id || 'temp-' + Date.now();
            const isPending = options.status === 'pending';

            const line = document.createElement('div');
            line.className = `flex gap-4 message-in ${isPending ? 'opacity-50' : ''}`;
            line.dataset.msgId = msgId;

            const time = document.createElement('span');
            time.className = 'text-zinc-700 min-w-[60px] text-[10px] font-mono pt-1';
            time.textContent = `[${formatTime(options.timestamp)}]`;

            const name = document.createElement('span');
            name.className = `${isMe ? 'text-blue-500' : 'text-green-500'} font-bold uppercase min-w-[80px] text-right text-xs pt-0.5`;
            name.textContent = `${sender}:`;

            const message = document.createElement('div');
            message.className = 'text-zinc-300 flex-1 break-words text-xs leading-relaxed whitespace-pre-wrap';

            line.appendChild(time);
            line.appendChild(name);
            line.appendChild(message);
            box.appendChild(line);

            if (options.animate !== false && (text || '').length <= 800 && !isPending) {
                typeText(message, text, {
                    onUpdate: () => { box.scrollTop = box.scrollHeight; }
                });
            } else {
                message.textContent = text || '';
            }
            requestAnimationFrame(() => { box.scrollTop = box.scrollHeight; });
        }

        function handleChatMessage(msg) {
            if (!msg || !msg.msg) return;
            const key = getMessageKey(msg);

            if (msg.from === 'master-ui') {
                const pending = document.querySelector(`.message-in[style*="opacity: 0.5"]`);
                if (pending) {
                    pending.style.opacity = '1';
                    pending.dataset.status = 'sent';
                }
            }

            if (!rememberMessage(key)) return;

            const room = msg.to === 'all' ? 'all' : (msg.from === 'master-ui' ? msg.to : msg.from);
            if (!chatHistory[room]) chatHistory[room] = [];
            chatHistory[room].push(msg);

            if (room === currentRoom || (currentRoom === 'all' && msg.to === 'all')) {
                if (msg.from !== 'master-ui') {
                    addLog(msg.from, msg.msg, false, { timestamp: msg.ts });
                }
            } else {
                // Background notification logic could go here
                console.log(`Msg in ${room} while in ${currentRoom}`);
            }
        }

        function handleRoomUpdate(data) {
            if (data.room === currentRoom) {
                updateMemberList(data.members);
            }
        }

        function handleTraffic(entry) {
            const feed = document.getElementById('traffic-feed');
            const lines = document.getElementById('traffic-lines');
            if (!feed || !lines) return;

            feed.classList.remove('hidden');
            const div = document.createElement('div');
            const colorClass = entry.status === 'blocked' ? 'text-red-500' : (entry.status === 'flagged' ? 'text-yellow-500' : 'text-zinc-500');
            div.className = `${colorClass} flex gap-2`;
            div.innerHTML = `<span>[${new Date().toLocaleTimeString()}]</span> <span class="font-bold">${entry.agent_id}</span> <span>${entry.cmd}</span> <span class="italic">(${entry.status})</span>`;

            lines.prepend(div);
            if (lines.children.length > 50) lines.lastChild.remove();
        }

        function updateMemberList(members) {
            const list = document.getElementById('member-list');
            if (!list) return;
            if (!members || members.length === 0) {
                list.innerHTML = '<div class="text-[10px] text-zinc-700 italic text-center mt-4">No members online</div>';
                return;
            }
            list.innerHTML = members.map(m => `
                <div class="flex items-center gap-2 px-2 py-1 member-item">
                    <span class="w-1.5 h-1.5 rounded-full ${m.status === 'online' ? 'bg-green-500' : 'bg-zinc-600'}"></span>
                    <span class="text-[11px] ${m.id === 'master-ui' ? 'text-blue-400 font-bold' : 'text-zinc-400'}">${m.id}</span>
                    <span class="text-[8px] text-zinc-700 uppercase font-mono ml-auto">${m.role}</span>
                </div>
            `).join('');
        }

        function typingKey(msg) {
            return `${msg.from || ''}|${msg.to || 'all'}`;
        }

        function renderTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (!indicator) return;
            const relevant = Array.from(activeTypers.values()).filter(entry => {
                return entry.to === 'all' || entry.to === currentRoom || entry.from === currentRoom;
            });
            if (relevant.length === 0) {
                indicator.innerHTML = '';
                return;
            }
            const names = relevant.map(entry => entry.from).join(', ');
            indicator.innerHTML = '';
            const text = document.createElement('span');
            text.textContent = `${names} typing`;
            const dots = document.createElement('span');
            dots.className = 'typing-dots';
            for (let i = 0; i < 3; i += 1) {
                const dot = document.createElement('span');
                dots.appendChild(dot);
            }
            indicator.appendChild(text);
            indicator.appendChild(dots);
        }

        function refreshLogs() {
            const serverSearch = document.getElementById('server-logs-search')?.value || '';
            const taskSearch = document.getElementById('task-logs-search')?.value || '';

            // Server Logs
            fetch(`/api/logs/server?search=${encodeURIComponent(serverSearch)}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('server-logs').innerText = (data.lines || []).join('\n');
                })
                .catch(err => console.error('Failed to fetch server logs:', err));

            // Task Logs
            fetch(`/api/logs/tasks?search=${encodeURIComponent(taskSearch)}`)
                .then(res => res.json())
                .then(data => {
                    const logsDiv = document.getElementById('task-logs');
                    logsDiv.innerHTML = (data.tasks || []).map(t => `
                        <div class="mb-2 pb-2 border-b border-zinc-800/30 last:border-0">
                            <div class="flex justify-between text-zinc-500 mb-1">
                                <span class="font-bold text-zinc-400">#${t.id.substring(0, 8)}</span>
                                <span>${new Date(t.created_at || t.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="text-zinc-300 mb-1">&gt; ${t.cmd}</div>
                            <div class="text-[10px] text-zinc-600 font-mono truncate">Result: ${typeof t.result === 'object' ? JSON.stringify(t.result) : t.result || 'Pending'}</div>
                        </div>
                    `).join('');
                })
                .catch(err => console.error('Failed to fetch task logs:', err));
        }

        // Logs Search Handlers
        function setupLogsSearch() {
            const serverSearch = document.getElementById('server-logs-search');
            const taskSearch = document.getElementById('task-logs-search');
            let serverTimeout, taskTimeout;

            if (serverSearch) {
                serverSearch.addEventListener('input', () => {
                    clearTimeout(serverTimeout);
                    serverTimeout = setTimeout(refreshLogs, 300);
                });
            }

            if (taskSearch) {
                taskSearch.addEventListener('input', () => {
                    clearTimeout(taskTimeout);
                    taskTimeout = setTimeout(refreshLogs, 300);
                });
            }

            // Refresh buttons
            document.getElementById('logs-refresh')?.addEventListener('click', refreshLogs);
            document.getElementById('task-logs-refresh')?.addEventListener('click', refreshLogs);

            // Initial load
            if (document.getElementById('logs') && !document.getElementById('logs').classList.contains('hidden')) {
                refreshLogs();
            }
        }

        // ... inside DOMContentLoaded ...
        setupLogsSearch();

        function selectRoom(target) {
            currentRoom = target;
            document.querySelectorAll('.channel-item').forEach(r => r.classList.remove('active'));

            const btn = document.querySelector(`button[onclick="selectRoom('${target}')"]`);
            if (btn) btn.classList.add('active');

            const label = target.startsWith('#') ? target : (target === 'all' ? '# BROADCAST_ALL' : `@ ${target.toUpperCase()}`);
            document.getElementById('chat-title').innerText = label;
            document.getElementById('master-input').placeholder = `Message ${label}...`;

            const box = document.getElementById('chat-box');
            box.innerHTML = '';

            if (chatHistory[target] && chatHistory[target].length > 0) {
                chatHistory[target].forEach(msg => {
                    addLog(msg.from, msg.msg, msg.from === 'master-ui', { timestamp: msg.ts, animate: false });
                });
            } else {
                box.innerHTML = '<div class="text-zinc-700 italic mb-4 text-[10px] text-center mt-10">-- START OF ENCRYPTED CHANNEL --</div>';
            }

            // Request room join and member list
            socket.emit('join_room', { room: target });
            renderTypingIndicator();
        }

        function joinNewRoom() {
            const name = prompt('ENTER_ROOM_NAME (e.g. #squad-alpha):');
            if (name) {
                const roomId = name.startsWith('#') ? name : '#' + name;
                selectRoom(roomId);
                // Proactively add to list if not present
                const roomList = document.getElementById('room-list');
                if (!document.querySelector(`button[onclick="selectRoom('${roomId}')"]`)) {
                    const btn = document.createElement('button');
                    btn.onclick = () => selectRoom(roomId);
                    btn.className = "channel-item w-full text-left px-4 py-3 text-xs text-zinc-400 hover:bg-zinc-800 border-b border-zinc-800/50";
                    btn.innerText = roomId.toUpperCase();
                    roomList.appendChild(btn);
                }
            }
        }

        function openAgentModal(agentId) {
            currentAgentId = agentId;
            const modal = document.getElementById('agent-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Reset fields
            document.getElementById('agent-modal-title').innerText = 'Loading...';
            document.getElementById('agent-modal-id').innerText = agentId;
            ['role', 'status', 'ip', 'last-seen', 'cpu', 'ram', 'hostname', 'uptime', 'version', 'os', 'sessions-count'].forEach(id => {
                document.getElementById(`agent-modal-${id}`).innerText = '...';
            });
            document.getElementById('agent-modal-tasks').innerHTML = '<tr><td colspan="3" class="p-4 text-center text-zinc-600 text-xs">Loading tasks...</td></tr>';

            fetch(`/api/agents/${agentId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        showToast('Agent not found', 'error');
                        modal.classList.add('hidden');
                        return;
                    }

                    const agent = data.agent;

                    document.getElementById('agent-modal-title').innerText = agent.id;
                    document.getElementById('agent-modal-id').innerText = agent.id;
                    document.getElementById('agent-modal-role').innerText = agent.role;
                    document.getElementById('agent-modal-status').innerText = agent.status;
                    document.getElementById('agent-modal-ip').innerText = agent.ip || 'Unknown';
                    document.getElementById('agent-modal-last-seen').innerText = new Date(agent.last_seen).toLocaleString();
                    document.getElementById('agent-modal-cpu').innerText = `${(agent.specs && agent.specs.cpu_percent) || 0}%`;
                    document.getElementById('agent-modal-ram').innerText = `${(agent.specs && agent.specs.ram_percent) || 0}%`;
                    document.getElementById('agent-modal-hostname').innerText = (agent.specs && agent.specs.hostname) || 'Unknown';
                    document.getElementById('agent-modal-version').innerText = (agent.specs && agent.specs.version) || 'Unknown';
                    document.getElementById('agent-modal-os').innerText = (agent.specs && agent.specs.os) || 'Unknown';
                    document.getElementById('agent-modal-sessions-count').innerText = (agent.sessions && agent.sessions.length) || 0;

                    // Render Tasks
                    const tasksBody = document.getElementById('agent-modal-tasks');
                    if (data.tasks && data.tasks.length > 0) {
                        tasksBody.innerHTML = data.tasks.slice().reverse().map(t => `
                            <tr class="hover:bg-zinc-800/30 transition-colors">
                                <td class="p-2 truncate max-w-[200px]" title="${t.cmd}">${t.cmd}</td>
                                <td class="p-2"><span class="${t.status === 'SUCCESS' ? 'text-green-500' : t.status === 'FAIL' ? 'text-red-500' : 'text-zinc-500'}">${t.status}</span></td>
                                <td class="p-2 text-zinc-600 font-mono">${new Date(t.created_at).toLocaleTimeString()}</td>
                            </tr>
                        `).join('');
                    } else {
                        tasksBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-zinc-600 text-xs">No recent tasks</td></tr>';
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast('Failed to load agent details', 'error');
                });
        }

        // --- 5. EVENT LISTENERS ---

        if (opsDispatch) {
            opsDispatch.addEventListener('click', () => {
                const target = document.getElementById('ops-target').value;
                const cmd = document.getElementById('ops-command').value.trim();
                if (!cmd) return;
                socket.emit('dispatch', { to: target, cmd: cmd });
                document.getElementById('ops-command').value = '';
            });
            document.getElementById('ops-command').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') opsDispatch.click();
            });
        }

        if (masterInput) {
            let typingActive = false;
            let typingTimeoutId = null;
            let lastTypingSent = 0;

            const sendTyping = (isTyping) => {
                socket.emit('typing', { to: currentRoom, isTyping: isTyping });
            };

            const stopTyping = () => {
                if (!typingActive) return;
                typingActive = false;
                if (typingTimeoutId) clearTimeout(typingTimeoutId);
                typingTimeoutId = null;
                sendTyping(false);
            };

            masterInput.addEventListener('input', () => {
                const hasText = masterInput.value.trim().length > 0;
                const now = Date.now();
                if (hasText) {
                    if (!typingActive) {
                        typingActive = true;
                        sendTyping(true);
                        lastTypingSent = now;
                    } else if (now - lastTypingSent > TYPING_THROTTLE_MS) {
                        sendTyping(true);
                        lastTypingSent = now;
                    }
                    if (typingTimeoutId) clearTimeout(typingTimeoutId);
                    typingTimeoutId = setTimeout(() => {
                        stopTyping();
                    }, TYPING_TTL_MS);
                } else {
                    stopTyping();
                }
            });

            masterInput.addEventListener('blur', () => {
                stopTyping();
            });

            masterInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const msg = masterInput.value.trim();
                    if (!msg) return;

                    stopTyping();

                    if (msg.startsWith('/exec ')) {
                        const cmd = msg.replace('/exec ', '');
                        socket.emit('dispatch', { to: currentRoom === 'all' ? 'all' : currentRoom, cmd: cmd });
                        addLog('SYSTEM', `Dispatching command to ${currentRoom}: ${cmd}`, true, { animate: false });
                    } else {
                        socket.emit('chat', { to: currentRoom, msg: msg });

                        addLog('YOU', msg, true, { status: 'pending', animate: false });

                        if (!chatHistory[currentRoom]) chatHistory[currentRoom] = [];
                        chatHistory[currentRoom].push({
                            from: 'master-ui',
                            to: currentRoom,
                            msg: msg,
                            ts: new Date().toISOString()
                        });
                    }
                    masterInput.value = '';
                }
            });
        }

        if (logsRefresh) logsRefresh.addEventListener('click', refreshLogs);

        if (modalClose) {
            modalClose.addEventListener('click', () => {
                document.getElementById('agent-modal').classList.add('hidden');
                document.getElementById('agent-modal').classList.remove('flex');
            });
        }

        if (modalDispatch) {
            modalDispatch.addEventListener('click', () => {
                const cmd = document.getElementById('agent-modal-command').value.trim();
                if (!cmd || !currentAgentId) return;
                socket.emit('dispatch', { to: currentAgentId, cmd: cmd });
                document.getElementById('agent-modal-command').value = '';
            });
        }

        if (modalRoleApply) {
            modalRoleApply.addEventListener('click', () => {
                const newRole = document.getElementById('agent-modal-role-select').value;
                if (!currentAgentId) return;
                socket.emit('reassign_role', { agent_id: currentAgentId, role: newRole });
            });
        }

        // Task Output Modal Functions
        const taskModalClose = document.getElementById('task-modal-close');

        function showTaskOutput(taskId) {
            const task = tasksCache.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('task-modal').classList.remove('hidden');
            document.getElementById('task-modal').classList.add('flex');
            document.getElementById('task-modal-id').textContent = '#' + task.id.substring(0, 8);
            document.getElementById('task-modal-agent').textContent = task.agent_id;
            document.getElementById('task-modal-cmd').textContent = task.cmd;
            document.getElementById('task-modal-status').textContent = task.status || 'UNKNOWN';
            document.getElementById('task-modal-status').className = 'text-zinc-200 ' + (task.status === 'SUCCESS' ? 'text-green-500' : task.status === 'FAIL' ? 'text-red-500' : 'text-zinc-500');

            let output = '';
            if (task.result) {
                if (typeof task.result === 'string') {
                    output = task.result;
                } else if (task.result.stdout) {
                    output = task.result.stdout;
                    if (task.result.stderr) output += '\n\nSTDERR:\n' + task.result.stderr;
                }
            }
            document.getElementById('task-modal-output').textContent = output || 'No output available.';
        }

        if (taskModalClose) {
            taskModalClose.addEventListener('click', () => {
                document.getElementById('task-modal').classList.add('hidden');
                document.getElementById('task-modal').classList.remove('flex');
            });
        }

        // Agent Logs Modal
        const agentLogsModal = document.getElementById('agent-logs-modal');
        const agentLogsClose = document.getElementById('agent-logs-close');
        const agentLogsButton = document.getElementById('agent-modal-logs');

        function showAgentLogs(agentId) {
            const agentTasks = tasksCache.filter(t => t.agent_id === agentId);

            document.getElementById('agent-logs-agent-id').textContent = agentId;
            const logsBox = document.getElementById('agent-logs-content');
            if (agentTasks.length === 0) {
                logsBox.innerHTML = '<div class="text-zinc-600 text-[10px] italic">No task logs for this agent.</div>';
            } else {
                logsBox.innerHTML = agentTasks.map(t => {
                    const status = (t.status || 'UNKNOWN').toUpperCase();
                    const statusClass = status === 'SUCCESS' ? 'text-green-500' : status === 'FAIL' ? 'text-red-500' : 'text-zinc-500';
                    const output = t.result && t.result.stdout ? t.result.stdout.substring(0, 200) : (typeof t.result === 'string' ? t.result.substring(0, 200) : '');
                    return `
                        <div class="border-b border-zinc-800/50 py-2">
                            <div class="flex gap-2 text-[10px] mb-1">
                                <span class="text-zinc-500">${new Date(t.ts).toLocaleTimeString()}</span>
                                <span class="${statusClass} font-bold">${status}</span>
                                <span class="text-zinc-600 font-mono">#${t.id.substring(0, 8)}</span>
                            </div>
                            <div class="text-zinc-400 text-[10px] font-mono bg-black/30 rounded p-2">${t.cmd}</div>
                            ${output ? `<div class="text-zinc-500 text-[10px] font-mono mt-1 whitespace-pre-wrap">${output}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            agentLogsModal.classList.remove('hidden');
            agentLogsModal.classList.add('flex');
        }

        if (agentLogsButton) {
            agentLogsButton.addEventListener('click', () => {
                if (currentAgentId) {
                    showAgentLogs(currentAgentId);
                }
            });
        }

        document.getElementById('agent-modal-restart').addEventListener('click', () => {
            if (!currentAgentId) return;
            if (confirm(`Send RESTART signal to ${currentAgentId}?`)) {
                socket.emit('dispatch', { to: currentAgentId, cmd: '/restart' });
            }
        });

        document.getElementById('agent-modal-update').addEventListener('click', () => {
            if (!currentAgentId) return;
            if (confirm(`Send UPDATE signal to ${currentAgentId}?`)) {
                socket.emit('dispatch', { to: currentAgentId, cmd: '/update' });
            }
        });

        document.getElementById('agent-modal-inspect').addEventListener('click', () => {
            if (!currentAgentId) return;
            // Placeholder for Shell functionality
            showToast('Interactive Shell coming soon!', 'info');
        });

        if (agentLogsClose) {
            agentLogsClose.addEventListener('click', () => {
                agentLogsModal.classList.add('hidden');
                agentLogsModal.classList.remove('flex');
            });
        }

        setupLogsSearch();
    </script>
</body>

</html>
