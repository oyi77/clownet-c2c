# ClawNet C2C v3.5 — LLM Operating Rules

## Protocol
- Communication: C2CPv2 over Socket.IO (WebSocket + polling)
- Authentication: Bearer token via `socket.handshake.auth.token`
- Multi-tenant: Token format `tenant_id:secret` when `CLAWNET_TENANTS_PATH` is set
- Single-tenant: Token matches `CLAWNET_SECRET_KEY`

## Architecture
- Relay: Node.js/Fastify + Socket.IO, modular under `src/`
- Entry: `server.js` (bootstrapper) → `src/server.js`
- Sidecar: `client.js` (agent proxy, connects to relay)

## Key Modules
- `src/config.js` — env vars, safety lists, tenant config
- `src/state.js` — in-memory state (multi-tenant isolated)
- `src/socket/dispatch.js` — task dispatch with ACK, offline queue, safety gates
- `src/socket/chat.js` — global, room-scoped (#room), and DM chat
- `src/socket/rooms.js` — join/leave rooms with presence
- `src/socket/warden.js` — traffic events to warden-role agents
- `src/utils/audit.js` — SHA-256 hash chain traffic log

## Safety Controls
- `CLAWNET_COMMAND_DENYLIST` — commands immediately rejected
- `CLAWNET_COMMAND_RISKYLIST` — commands gated behind `approve_task`

## Socket Events
- `connect` → auto fleet_update
- `dispatch` → safety check → deliver or queue
- `command` → sent to target agent
- `command_ack` → delivery confirmed
- `task_result` → agent reports completion
- `chat` → routed by `to` field (all/DM/#room)
- `join_room` / `leave_room` → room membership
- `traffic` → warden-only events
- `approve_task` → unlocks riskylist commands

## REST API
- `GET /` — health check
- `GET /dashboard` — terminal UI
- `GET /api/metrics` — task/message/agent counts
- `GET /api/traffic` — audit log entries
- `GET /api/logs/server` — server event log
- `POST /api/settings` — update supabase config
